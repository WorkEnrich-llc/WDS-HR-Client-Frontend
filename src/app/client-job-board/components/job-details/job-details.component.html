<main class="job-details-container" role="main" [attr.aria-label]="
    job ? 'Job details for ' + getJobTitle(job) : 'Job details'
  " [attr.aria-busy]="isLoading || isLoadingRelated">
  <!-- Loading State -->
  @if (isLoading) {
  <div role="status" aria-live="polite" aria-busy="true" [attr.aria-label]="getLoadingAnnouncement()" class="sr-only">
    Loading job details, please wait...
  </div>
  <div class="skeleton-loader" role="progressbar" aria-label="Loading job details" aria-valuetext="Loading">
    <div class="skeleton skeleton-header"></div>
    <div class="skeleton skeleton-content"></div>
    <div class="skeleton skeleton-content"></div>
    <div class="skeleton skeleton-content short"></div>
  </div>
  }

  <!-- Error State -->
  @if (errorMessage && !isLoading) {
  <div class="error-container">
    <div role="alert" aria-live="assertive" class="error-card-centered" aria-describedby="error-description">
      <div class="error-illustration-wrapper">
        <svg
          width="280"
          height="200"
          viewBox="0 0 280 200"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          focusable="false"
          class="error-illustration"
        >
          <!-- Background Circle -->
          <circle cx="140" cy="100" r="80" fill="url(#completedGradient)" opacity="0.1"/>
          
          <!-- Main Completed Icon -->
          <g transform="translate(100, 60)">
            <!-- Outer Circle -->
            <circle cx="40" cy="40" r="38" fill="url(#completedGradient)" opacity="0.2" stroke="url(#completedGradient)" stroke-width="2"/>
            <!-- Inner Circle -->
            <circle cx="40" cy="40" r="32" fill="url(#completedGradient)" opacity="0.3"/>
            
            <!-- Checkmark -->
            <path
              d="M28 40L34 46L52 28"
              stroke="var(--client-job-board-primary, #377afd)"
              stroke-width="4"
              stroke-linecap="round"
              stroke-linejoin="round"
              fill="none"
            />
          </g>
          
          <!-- Decorative Elements -->
          <circle cx="60" cy="40" r="4" fill="var(--client-job-board-primary, #377afd)" opacity="0.6"/>
          <circle cx="220" cy="40" r="4" fill="var(--client-job-board-primary, #377afd)" opacity="0.6"/>
          <circle cx="60" cy="160" r="4" fill="var(--client-job-board-primary, #377afd)" opacity="0.6"/>
          <circle cx="220" cy="160" r="4" fill="var(--client-job-board-primary, #377afd)" opacity="0.6"/>
          
          <!-- Additional Small Circles for Depth -->
          <circle cx="80" cy="30" r="2" fill="var(--client-job-board-primary-light, #2c63cc)" opacity="0.5"/>
          <circle cx="200" cy="50" r="2" fill="var(--client-job-board-primary-light, #2c63cc)" opacity="0.5"/>
          <circle cx="70" cy="170" r="2" fill="var(--client-job-board-primary-light, #2c63cc)" opacity="0.5"/>
          <circle cx="210" cy="150" r="2" fill="var(--client-job-board-primary-light, #2c63cc)" opacity="0.5"/>
          
          <!-- Gradient Definition -->
          <defs>
            <linearGradient id="completedGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:var(--client-job-board-primary, #377afd);stop-opacity:0.2" />
              <stop offset="100%" style="stop-color:var(--client-job-board-primary-dark, #2c63cc);stop-opacity:0.3" />
            </linearGradient>
          </defs>
        </svg>
      </div>
      
      <div class="error-content">
        <p id="error-description" class="error-description-centered">
          {{ errorMessage }}
        </p>
      </div>
      
      <div class="error-actions-centered">
        <a routerLink="/careers" class="error-back-button-large" aria-label="Go back to job listings">
          <svg width="22" height="22" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true" focusable="false">
            <path d="M10.5 12.75L7.5 9L10.5 5.25" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          Back to Jobs
        </a>
      </div>
    </div>
  </div>
  }

  <!-- Job Details Content - Two Column Layout -->
  @if (!isLoading && job && !errorMessage) {
  <div class="job-details-layout">
    <!-- Left Column - Main Job Details -->
    <div class="job-details-main">
      <!-- Back Button -->
      <nav class="back-navigation" aria-label="Back to job listings">
        <a routerLink="/careers" class="back-link" aria-label="Go back to job listings">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true" focusable="false">
            <path d="M10.5 12.75L7.5 9L10.5 5.25" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          <span>Back to Jobs</span>
        </a>
      </nav>

      <!-- Job Information Card -->
      <article class="job-info-card" [attr.aria-labelledby]="'job-title-' + job.id" [attr.aria-describedby]="
          'job-meta-' + job.id + ' job-description-heading'
        " [attr.aria-label]="getJobCardAriaLabel(job)">
        <div class="job-tags" role="list" aria-label="Job tags">
          <span class="tag tag-primary" role="listitem" [attr.aria-label]="'Job level: ' + getJobLevel(job)">{{
            getJobLevel(job) }}</span>
          @if (isJobNew(job.created_at)) {
          <span class="tag tag-new" role="listitem" aria-label="New job posting, posted within the last 7 days">
            <span class="sr-only">New: </span>NEW!
          </span>
          }
          <span class="tag tag-secondary" role="listitem"
            [attr.aria-label]="'Employment type: ' + getEmploymentType(job)">{{ getEmploymentType(job) }}</span>
          <span class="tag tag-secondary" role="listitem"
            [attr.aria-label]="'Work schedule: ' + getWorkSchedule(job)">{{ getWorkSchedule(job) }}</span>
        </div>

        <h1 class="job-title" [attr.id]="'job-title-' + job.id" tabindex="-1">
          {{ getJobTitle(job) }}
        </h1>

        <div class="job-meta-info" [attr.id]="'job-meta-' + job.id" role="list" aria-label="Job information">
          <div class="job-meta-item" role="listitem">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true" focusable="false">
              <path opacity="0.3"
                d="M14.7874 15.2718C15.8573 14.6884 16.5 13.9405 16.5 13.125C16.5 12.2606 15.7779 11.4721 14.5903 10.875C13.217 10.1845 11.2212 9.75 9 9.75C6.77875 9.75 4.78304 10.1845 3.40973 10.875C2.22213 11.4721 1.5 12.2606 1.5 13.125C1.5 13.9894 2.22213 14.7779 3.40973 15.375C4.78304 16.0655 6.77875 16.5 9 16.5C11.33 16.5 13.4118 16.0219 14.7874 15.2718Z"
                fill="#4A6D97" />
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.75 6.38598C3.75 3.68753 6.10051 1.5 9 1.5C11.8995 1.5 14.25 3.68753 14.25 6.38598C14.25 9.06328 12.5744 12.1874 9.96005 13.3047C9.35061 13.5651 8.64939 13.5651 8.03995 13.3047C5.42562 12.1874 3.75 9.06328 3.75 6.38598ZM9 8.25C9.82843 8.25 10.5 7.57843 10.5 6.75C10.5 5.92157 9.82843 5.25 9 5.25C8.17157 5.25 7.5 5.92157 7.5 6.75C7.5 7.57843 8.17157 8.25 9 8.25Z"
                fill="#4A6D97" />
            </svg>
            <span>
              <span class="sr-only">Location: </span>{{ getJobBranch(job) }}
            </span>
          </div>
          <div class="job-meta-item" role="listitem">
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true" focusable="false">
              <path
                d="M9 1.5C4.85786 1.5 1.5 4.85786 1.5 9C1.5 13.1421 4.85786 16.5 9 16.5C13.1421 16.5 16.5 13.1421 16.5 9C16.5 4.85786 13.1421 1.5 9 1.5ZM9 15C5.68629 15 3 12.3137 3 9C3 5.68629 5.68629 3 9 3C12.3137 3 15 5.68629 15 9C15 12.3137 12.3137 15 9 15Z"
                fill="#4A6D97" />
              <path d="M9 5.25V9L11.25 10.5" stroke="#4A6D97" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            <span>
              <span class="sr-only">Experience required: </span>{{ getExperienceText(getJobLevel(job)) }}
            </span>
          </div>
        </div>

        <button class="apply-button" type="button" [attr.aria-label]="'Apply for ' + getJobTitle(job) + ' position'"
          [attr.aria-describedby]="'job-title-' + job.id" (click)="onApplyClick()" (keydown.enter)="onApplyClick()"
          (keydown.space)="onApplyClick(); $event.preventDefault()">
          <span>Apply Now</span>
          <span class="sr-only"> for {{ getJobTitle(job) }}</span>
        </button>
      </article>

      <!-- Combined Job Description and Requirements Card -->
      <section class="job-section-card" aria-labelledby="job-description-heading" [attr.aria-describedby]="
          job.job_requirements ? 'job-requirements-heading' : null
        ">
        <!-- Job Description Section -->
        <div class="section-block">
          <h2 id="job-description-heading" class="section-heading">
            Job Description
          </h2>
          <div class="section-content" role="region" [attr.aria-labelledby]="'job-description-heading'">
            <p [attr.aria-label]="'Job description for ' + getJobTitle(job)">
              {{ job.job_description }}
            </p>
          </div>
        </div>

        <!-- Separator -->
        @if (job.job_requirements) {
        <hr class="section-divider" aria-hidden="true" role="separator" />
        }

        <!-- Job Requirements Section -->
        @if (job.job_requirements) {
        <div class="section-block">
          <h2 id="job-requirements-heading" class="section-heading">
            Job Requirements
          </h2>
          <div class="section-content" role="region" [attr.aria-labelledby]="'job-requirements-heading'">
            <p [attr.aria-label]="'Job requirements for ' + getJobTitle(job)">
              {{ job.job_requirements }}
            </p>
          </div>
        </div>
        }

        <div class="section-actions">
          <button class="apply-button" type="button" [attr.aria-label]="'Apply for ' + getJobTitle(job) + ' position'"
            [attr.aria-describedby]="'job-title-' + job.id" (click)="onApplyClick()" (keydown.enter)="onApplyClick()"
            (keydown.space)="onApplyClick(); $event.preventDefault()">
            <span>Apply Now</span>
            <span class="sr-only"> for {{ getJobTitle(job) }}</span>
          </button>
        </div>
      </section>

      <!-- Feedback Section -->
      <section class="job-section-card" aria-labelledby="feedback-heading">
        <div class="section-block">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 id="feedback-heading" class="section-heading">Share Your Feedback</h2>
            <button type="button" class="view-btn add-sec d-flex align-items-center gap-1" (click)="openFeedbackModal()"
              aria-label="Add feedback for this job">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
                <g fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10" />
                  <path stroke-linecap="round" d="M15 12h-3m0 0H9m3 0V9m0 3v3" />
                </g>
              </svg>
              <span>Add Feedback</span>
            </button>
          </div>
          <p class="text-muted small">Help others by sharing your thoughts about this job opportunity</p>
        </div>
      </section>
    </div>

    <!-- Right Column - Related Opportunities -->
    <aside class="related-jobs-sidebar" aria-label="Related job opportunities" [attr.aria-busy]="isLoadingRelated">
      <h2 class="related-jobs-title" id="related-opportunities-heading">
        Related Opportunities
      </h2>

      @if (isLoadingRelated) {
      <div class="related-jobs-loading" role="status" aria-live="polite" aria-label="Loading related job opportunities">
        <span class="sr-only">Loading related job opportunities, please wait.</span>
        @for (item of [1, 2, 3]; track item) {
        <article class="related-job-card skeleton-card" role="article"
          [attr.aria-label]="'Loading related job ' + item">
          <div class="skeleton-job-tags" role="list" aria-hidden="true">
            <div class="skeleton skeleton-tag"></div>
            <div class="skeleton skeleton-tag"></div>
          </div>
          <div class="skeleton skeleton-job-category"></div>
          <div class="skeleton skeleton-job-title"></div>
          <div class="skeleton skeleton-job-location"></div>
          <div class="skeleton skeleton-job-description"></div>
        </article>
        }
      </div>
      } @else {
      <div class="related-jobs-list" role="list" [attr.aria-labelledby]="'related-opportunities-heading'"
        [attr.aria-label]="
          'List of ' + relatedJobs.length + ' related job opportunities'
        ">
        @for (relatedJob of relatedJobs; track relatedJob.id; let i = $index) {
        <article class="related-job-card" role="listitem" [attr.aria-labelledby]="'related-job-title-' + relatedJob.id"
          [attr.aria-posinset]="i + 1" [attr.aria-setsize]="relatedJobs.length">
          <a class="related-job-link" [routerLink]="['/careers', relatedJob.id]"
            [attr.aria-label]="getRelatedJobAriaLabel(relatedJob)"
            [attr.aria-describedby]="'related-job-title-' + relatedJob.id" tabindex="0"
            (keydown.enter)="router.navigate(['/careers', relatedJob.id])" (keydown.space)="
              router.navigate(['/careers', relatedJob.id]);
              $event.preventDefault()
            ">
            <div class="related-job-tags" role="list" aria-label="Job tags">
              <span class="tag tag-primary" role="listitem"
                [attr.aria-label]="'Job level: ' + getJobLevel(relatedJob)">{{ getJobLevel(relatedJob) }}</span>
              @if (isJobNew(relatedJob.created_at)) {
              <span class="tag tag-new" role="listitem" aria-label="New job posting">
                <span class="sr-only">New: </span>NEW!
              </span>
              }
              <span class="tag tag-secondary" role="listitem" [attr.aria-label]="
                  'Employment type: ' + getEmploymentType(relatedJob)
                ">{{ getEmploymentType(relatedJob) }}</span>
              <span class="tag tag-secondary" role="listitem" [attr.aria-label]="
                  'Work schedule: ' + getWorkSchedule(relatedJob)
                ">{{ getWorkSchedule(relatedJob) }}</span>
            </div>

            <h3 class="related-job-category" [attr.id]="'related-job-title-' + relatedJob.id">
              {{ getJobTitle(relatedJob) }}
            </h3>

            <div class="related-job-location">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                aria-hidden="true" focusable="false">
                <path opacity="0.3"
                  d="M14.7874 15.2718C15.8573 14.6884 16.5 13.9405 16.5 13.125C16.5 12.2606 15.7779 11.4721 14.5903 10.875C13.217 10.1845 11.2212 9.75 9 9.75C6.77875 9.75 4.78304 10.1845 3.40973 10.875C2.22213 11.4721 1.5 12.2606 1.5 13.125C1.5 13.9894 2.22213 14.7779 3.40973 15.375C4.78304 16.0655 6.77875 16.5 9 16.5C11.33 16.5 13.4118 16.0219 14.7874 15.2718Z"
                  fill="#4A6D97" />
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M3.75 6.38598C3.75 3.68753 6.10051 1.5 9 1.5C11.8995 1.5 14.25 3.68753 14.25 6.38598C14.25 9.06328 12.5744 12.1874 9.96005 13.3047C9.35061 13.5651 8.64939 13.5651 8.03995 13.3047C5.42562 12.1874 3.75 9.06328 3.75 6.38598ZM9 8.25C9.82843 8.25 10.5 7.57843 10.5 6.75C10.5 5.92157 9.82843 5.25 9 5.25C8.17157 5.25 7.5 5.92157 7.5 6.75C7.5 7.57843 8.17157 8.25 9 8.25Z"
                  fill="#4A6D97" />
              </svg>
              <span>
                <span class="sr-only">Location: </span>{{ getJobBranch(relatedJob) }}
              </span>
            </div>

            <p class="related-job-description" [attr.aria-label]="'Description: ' + relatedJob.job_description">
              {{ relatedJob.job_description }}
            </p>
          </a>
        </article>
        } @empty {
        <p class="no-related-jobs" role="status" aria-live="polite">
          No related opportunities available
        </p>
        }
      </div>
      }
    </aside>
  </div>
  }

  <!-- Feedback Overlay -->
  <app-overlay-filter-box #feedbackBox title="Share Your Feedback">
    <form class="w-100 d-flex flex-column gap-2" (ngSubmit)="submitFeedback()">
      <div class="info feedback">
        <h6 class="text-muted small">Rate This Job Opportunity</h6>
        <span><span>{{ rating || 0 }}</span> Out of 10</span>
      </div>

      <!-- Rating Input -->
      <div class="input">
        <label for="job-rating">Rate This Job</label>
        <div class="d-flex align-items-center gap-4">
          <div class="form-outline w-100 position-relative">
            <input type="number" id="job-rating" name="rating" class="form-control" placeholder="Rate out of 10"
              [(ngModel)]="rating" min="0" max="10" step="0.1" (focus)="clearFeedbackValidationError('rating')" />
            @if (feedbackValidationErrors['rating']) {
            <div class="text-danger small mt-2">
              {{ feedbackValidationErrors['rating'] }}
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Comment Input -->
      <div class="input">
        <label for="job-feedback">Your Feedback</label>
        <div class="d-flex align-items-center gap-4">
          <div class="form-outline w-100 position-relative">
            <textarea id="job-feedback" name="comment" class="form-control" [(ngModel)]="comment"
              placeholder="Share your thoughts about this job opportunity" rows="4"
              (focus)="clearFeedbackValidationError('comment')"></textarea>
            @if (feedbackValidationErrors['comment']) {
            <div class="text-danger small mt-2">
              {{ feedbackValidationErrors['comment'] }}
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="d-flex align-items-center gap-3 mt-3">
        <button type="submit" class="btn btn-lg btn-primary w-100" [disabled]="submitting || !job?.id"
          aria-label="Submit feedback for this job">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor"
              d="M16.03 10.03a.75.75 0 1 0-1.06-1.06l-4.47 4.47l-1.47-1.47a.75.75 0 0 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0z" />
            <path fill="currentColor" fill-rule="evenodd"
              d="M12 1.25C6.063 1.25 1.25 6.063 1.25 12S6.063 22.75 12 22.75S22.75 17.937 22.75 12S17.937 1.25 12 1.25M2.75 12a9.25 9.25 0 1 1 18.5 0a9.25 9.25 0 0 1-18.5 0"
              clip-rule="evenodd" />
          </svg>
          <span>{{ submitting ? 'Submitting...' : 'Submit Feedback' }}</span>
        </button>
        <button type="button" class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeFeedbackOverlay()"
          aria-label="Close feedback form">
          <span>Cancel</span>
        </button>
      </div>
    </form>
  </app-overlay-filter-box>
</main>