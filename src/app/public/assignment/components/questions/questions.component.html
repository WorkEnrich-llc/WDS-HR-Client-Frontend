<div class="questions-page-wrapper">
  @if (!isLoading && !errorMessage && errorHandling.length === 0 && assignmentData) {
  <app-navbar
    [logo]="logoData"
    [socialMediaLinks]="socialMediaLinks"
    [websiteUrl]="websiteUrl"
    [showVisitWebsite]="true">
  </app-navbar>
  }

  <main class="assignment-questions-container" role="main" [attr.aria-label]="'Assignment questions for ' + getAssignmentTitle()">
  <!-- Loading State -->
  @if (isLoading) {
  <div role="status" aria-live="polite" aria-busy="true" class="sr-only">
    Loading assignment questions, please wait...
  </div>
  <div class="loading-container">
    <div class="skeleton-loader">
      <div class="skeleton skeleton-header"></div>
      <div class="skeleton skeleton-content"></div>
      <div class="skeleton skeleton-content"></div>
      <div class="skeleton skeleton-content short"></div>
    </div>
  </div>
  }

  <!-- Error State -->
  @if (!isLoading && (errorMessage || errorHandling.length > 0)) {
  <div role="alert" aria-live="assertive" class="error-container">
    <div class="error-card">
      <div class="error-icon-container">
        <svg
          width="64"
          height="64"
          viewBox="0 0 64 64"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          focusable="false"
          class="error-icon-main"
        >
          <circle cx="32" cy="32" r="30" fill="#FEE2E2" stroke="#FCA5A5" stroke-width="2"/>
          <circle cx="32" cy="32" r="24" fill="none" stroke="#DC2626" stroke-width="2" stroke-dasharray="2 2" opacity="0.3"/>
          <path
            d="M32 20V32L40 40"
            stroke="#DC2626"
            stroke-width="3"
            stroke-linecap="round"
            stroke-linejoin="round"
          />
          <circle cx="32" cy="32" r="3" fill="#DC2626"/>
        </svg>
      </div>
      <div class="error-content">
        <div class="error-description">
          @if (errorHandling.length > 0) {
            @for (error of errorHandling; track error.field) {
              <p class="error-message">{{ error.error }}</p>
            }
          } @else if (errorMessage) {
            <p class="error-message">{{ errorMessage }}</p>
          }
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Questions Content -->
  @if (!isLoading && !errorMessage && errorHandling.length === 0 && assignmentData) {
  <div class="questions-content">
    <!-- Header Section -->
    <div class="questions-header">
      <h1 class="assignment-title">{{ getAssignmentTitle() }}</h1>

      <!-- Timer Bar -->
      <div class="timer-container">
        <div class="timer-bar">
          <div class="timer-progress" [style.width.%]="getTimerProgress()" [class.full-width]="getTimerProgress() >= 100">
            @if (getTimerProgress() >= 8) {
            <span class="time-remaining">{{ getTimeRemaining() }}</span>
            }
          </div>
          @if (getTimerProgress() < 100) {
          <div class="timer-remaining-section" [class.overlapped]="getTimerProgress() > 75">
            <span class="time-total">{{ getTotalTime() }}</span>
          </div>
          }
        </div>
      </div>

      <!-- Total Questions -->
      <div class="total-questions">
        <span class="done-count">{{ getAnsweredCount() }} Done</span>
        <span class="total-count">{{ getTotalQuestions() }} Total Questions</span>
      </div>

      <!-- Question Progress Indicators -->
      <div class="question-indicators" role="list" aria-label="Question progress">
        @for (question of questions; track question.id; let i = $index) {
        <button
          type="button"
          class="question-indicator"
          [class.active]="i === currentQuestionIndex"
          [class.answered]="isQuestionAnswered(i)"
          [attr.aria-label]="'Question ' + (i + 1) + (i === currentQuestionIndex ? ' current' : '')"
          (click)="goToQuestion(i)">
          <span class="question-number">{{ i + 1 }}</span>
        </button>
        }
      </div>
    </div>

    <!-- Question Card -->
    @if (getCurrentQuestion()) {
    <div class="question-card">
      <h2 class="question-title">{{ getCurrentQuestion().text }}</h2>
      
      <!-- MCQ Question -->
      @if (getCurrentQuestion().type === 'MCQ') {
      <div class="mcq-answers">
        @for (answer of getCurrentQuestion().answers; track answer.id) {
        <label class="mcq-option" [class.selected]="currentSelectedAnswerId === answer.id">
          <input
            type="radio"
            [name]="'question-' + getCurrentQuestion().id"
            [value]="answer.id"
            [checked]="currentSelectedAnswerId === answer.id"
            (change)="onAnswerSelect(answer.id)"
            [attr.aria-label]="'Select answer: ' + answer.text"
          />
          <span class="radio-custom"></span>
          <span class="answer-text">{{ answer.text }}</span>
        </label>
        }
      </div>
      }
      
      <!-- Text Question -->
      @if (getCurrentQuestion().type === 'text' || getCurrentQuestion().type !== 'MCQ') {
      <textarea
        class="answer-input"
        [(ngModel)]="currentAnswer"
        (blur)="saveAnswer()"
        (input)="validationError = null"
        placeholder="Answer"
        rows="8"
        [attr.aria-label]="'Answer for question ' + (currentQuestionIndex + 1)">
      </textarea>
      }

      <!-- Validation Error Message -->
      @if (validationError) {
      <div class="validation-error" role="alert" aria-live="polite">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="2"/>
          <path d="M10 6V10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="10" cy="13" r="1" fill="currentColor"/>
        </svg>
        <span>{{ validationError }}</span>
      </div>
      }
    </div>
    }

    <!-- Navigation Buttons -->
    <div class="navigation-buttons">
      <!-- Go To Button -->
      <div class="go-to-container">
        <button
          type="button"
          class="go-to-button"
          (click)="toggleGoToDropdown()"
          [attr.aria-expanded]="showGoToDropdown"
          aria-label="Go to question">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true" focusable="false">
            <path d="M4.5 6.75L9 11.25L13.5 6.75" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
          <span>Go To</span>
        </button>
        @if (showGoToDropdown) {
        <div class="go-to-dropdown" role="menu">
          @for (question of questions; track question.id; let i = $index) {
          <button
            type="button"
            class="dropdown-item"
            [class.active]="i === currentQuestionIndex"
            [class.answered]="isQuestionAnswered(i)"
            (click)="goToQuestion(i)"
            role="menuitem">
            Question {{ i + 1 }}
            @if (isQuestionAnswered(i)) {
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"
              aria-hidden="true">
              <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
            }
          </button>
          }
        </div>
        }
      </div>

      <!-- Previous Button -->
      @if (currentQuestionIndex > 0) {
      <button
        type="button"
        class="previous-button"
        (click)="previousQuestion()"
        aria-label="Previous question">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true" focusable="false">
          <path d="M11.25 3.75L6.75 9L11.25 14.25" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        <span>Previous</span>
      </button>
      }

      <!-- Next Question Button -->
      <button
        type="button"
        class="next-button"
        (click)="nextQuestion()"
        [disabled]="isSubmittingAnswer"
        [attr.aria-label]="currentQuestionIndex < questions.length - 1 ? 'Next question' : 'Submit assignment'">
        @if (isSubmittingAnswer) {
        <div class="button-loader">
          <span class="bubble"></span>
          <span class="bubble"></span>
          <span class="bubble"></span>
        </div>
        <span>{{ currentQuestionIndex < questions.length - 1 ? 'Saving Answer...' : 'Submitting...' }}</span>
        } @else {
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true" focusable="false">
          <path d="M6.75 3.75L11.25 9L6.75 14.25" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        <span>{{ currentQuestionIndex < questions.length - 1 ? 'Next Question' : 'Submit Assignment' }}</span>
        }
      </button>
    </div>
  </div>
  }
  </main>

  @if (!isLoading && !errorMessage && errorHandling.length === 0 && assignmentData) {
  <div class="footer-wrapper">
    <app-footer [logo]="logoData"></app-footer>
  </div>
  }
</div>
