<div class="date-picker-wrapper">
    @if (label) {
    <label [for]="'date-picker-' + label" class="date-picker-label">
        {{ label }}
        @if (required) {
        <span class="required">*</span>
        }
    </label>
    }

    <div class="date-picker-container" [class.error]="errorMessage" [class.disabled]="disabled">
        <div #dateWrapper class="form-outline w-100 position-relative custom-date-wrapper">
            <input #dateInput type="text" [id]="'date-picker-' + label" class="form-control custom-date-input"
                [placeholder]="placeholder" [value]="displayValue" [disabled]="disabled" [required]="required"
                (click)="onInputClick($event)" (change)="onInputChange($event)" (blur)="onBlur()" readonly
                [attr.aria-required]="required" [attr.aria-invalid]="!!errorMessage"
                [attr.aria-describedby]="errorMessage ? 'date-error-' + label : null"
                [attr.aria-expanded]="isCalendarOpen.toString()" [attr.aria-haspopup]="true" />
            <svg class="date-picker-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                (click)="onIconClick($event)">
                <g fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round"
                        d="M22 14v-2c0-3.771 0-5.657-1.172-6.828S17.771 4 14 4h-4C6.229 4 4.343 4 3.172 5.172S2 8.229 2 12v2c0 3.771 0 5.657 1.172 6.828S6.229 22 10 22h4M7 4V2.5M17 4V2.5" />
                    <circle cx="18" cy="18" r="3" />
                    <path stroke-linecap="round" d="M20.5 20.5L22 22M2.5 9h19" />
                </g>
            </svg>
        </div>

        <!-- Calendar Popup -->
        @if (isCalendarOpen) {
        <div class="calendar-popup" #calendarPopup role="dialog" aria-modal="true" aria-label="Calendar"
            [class.position-above]="positionAbove">
            <!-- Calendar Header -->
            <div class="calendar-header-wrapper">
                <div class="calendar-header">
                    <button type="button" class="calendar-nav-btn" (click)="previousMonth()"
                        aria-label="Previous month">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                    <div class="calendar-month-year-container">
                        <button type="button" class="calendar-month-year-btn" (click)="toggleMonthPicker()"
                            aria-label="Select month" [class.active]="showMonthPicker">
                            <span>{{ getMonthName() }}</span>
                            <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <button type="button" class="calendar-month-year-btn" (click)="toggleYearPicker()"
                            aria-label="Select year" [class.active]="showYearPicker">
                            <span>{{ getCurrentYear() }}</span>
                            <svg class="dropdown-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                    <button type="button" class="calendar-nav-btn" (click)="nextMonth()" aria-label="Next month">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>

                <!-- Month Picker Dropdown -->
                @if (showMonthPicker) {
                <div class="picker-dropdown month-picker">
                    <div class="picker-grid">
                        @for (month of months; track $index) {
                        <button type="button" class="picker-item" [class.active]="$index === currentMonth"
                            (click)="selectMonth($index)" [attr.aria-label]="'Select ' + month">
                            {{ month }}
                        </button>
                        }
                    </div>
                </div>
                }

                <!-- Year Picker Dropdown -->
                @if (showYearPicker) {
                <div class="picker-dropdown year-picker">
                    <div class="year-picker-header">
                        <button type="button" class="year-nav-btn" (click)="previousYearPage()"
                            [disabled]="!canGoToPreviousYearPage()" aria-label="Previous years">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                        <div class="year-range">
                            {{ yearPickerStartYear }} - {{ yearPickerEndYear }}
                        </div>
                        <button type="button" class="year-nav-btn" (click)="nextYearPage()"
                            [disabled]="!canGoToNextYearPage()" aria-label="Next years">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </button>
                    </div>
                    <div class="picker-grid year-grid">
                        @for (yearData of years; track yearData.year) {
                        <button type="button" class="picker-item" [class.active]="yearData.year === currentYear"
                            [class.disabled]="yearData.disabled" [disabled]="yearData.disabled"
                            (click)="selectYear(yearData)" [attr.aria-label]="'Select year ' + yearData.year"
                            [attr.aria-disabled]="yearData.disabled">
                            {{ yearData.year }}
                        </button>
                        }
                    </div>
                </div>
                }
            </div>

            <!-- Week Days Header -->
            <div class="calendar-weekdays">
                @for (day of weekDays; track day) {
                <div class="calendar-weekday">{{ day }}</div>
                }
            </div>

            <!-- Calendar Days Grid -->
            <div class="calendar-days">
                @for (day of calendarDays; track $index) {
                <button type="button" class="calendar-day" [class.disabled]="day.disabled" [class.today]="day.isToday"
                    [class.selected]="day.isSelected" [class.other-month]="day.isOtherMonth" [disabled]="day.disabled"
                    (click)="selectDate(day)"
                    [attr.aria-label]="day.date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })">
                    {{ day.date.getDate() }}
                </button>
                }
            </div>
        </div>
        }
    </div>

    @if (errorMessage) {
    <div class="date-picker-error" [id]="'date-error-' + label" role="alert">
        <svg class="error-icon" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                clip-rule="evenodd" />
        </svg>
        <span>{{ errorMessage }}</span>
    </div>
    }
</div>