<!-- page header -->
<app-page-header [breadcrumbs]="[
    { label: 'Attendance', link: '/attendance' },
    { label: 'Attendance Rules', link: '/attendance-rules' },
    { label: 'Edit Part Time Rules' }
  ]" title="Edit Absence - Part Time">
  <button class="btn btn-lg btn-success" [disabled]="isSaving || !hasChanges()" (click)="saveChanges()">
    @if (isSaving) {
    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
    }
    @if (!isSaving) {
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10" />
        <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
      </g>
    </svg>
    }
    <span>Save Changes</span>
  </button>

  <button class="btn btn-lg btn-outline-dark w-auto" (click)="openModal()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10" />
        <path stroke-linecap="round" d="m14.5 9.5l-5 5m0-5l5 5" />
      </g>
    </svg>
    <span>Discard Changes</span>
  </button>
</app-page-header>
<!-- end page header -->
<!-- steps navigation -->
<ul class="nav d-flex align-items-center nav-tabs bg-white px-3" role="tablist" aria-label="Attendance Rules Steps">

  <li class="nav-item" role="presentation" [ngClass]="{
        'active': currentStep === 1
    }" (click)="goToStep(1)" (keydown)="handleTabKeydown($event)" [attr.aria-selected]="currentStep === 1"
    [attr.tabindex]="currentStep === 1 ? '0' : '-1'" role="tab" id="tab-1" aria-controls="panel-1"
    aria-label="Step 1: Lateness" style="cursor: pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path fill-rule="evenodd"
        d="M10.47 8.47a.75.75 0 0 0 0 1.06l1.72 1.72H4a.75.75 0 0 0 0 1.5h8.19l-1.72 1.72a.75.75 0 1 0 1.06 1.06l3-3a.75.75 0 0 0 0-1.06l-3-3a.75.75 0 0 0-1.06 0"
        clip-rule="evenodd" />
      <path d="M12 20a8 8 0 1 0 0-16z" opacity=".5" />
    </svg>
    <span class="nav-link">Lateness</span>
  </li>



  <li class="nav-item" role="presentation" [ngClass]="{
        'active': currentStep === 2
    }" (click)="goToStep(2)" (keydown)="handleTabKeydown($event)" [attr.aria-selected]="currentStep === 2"
    [attr.tabindex]="currentStep === 2 ? '0' : '-1'" role="tab" id="tab-2" aria-controls="panel-2"
    aria-label="Step 2: Early Leave" style="cursor: pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 20a8 8 0 1 1 0-16z" opacity=".5" />
      <path fill-rule="evenodd"
        d="M16.47 8.47a.75.75 0 0 0 0 1.06l1.72 1.72H10a.75.75 0 0 0 0 1.5h8.19l-1.72 1.72a.75.75 0 1 0 1.06 1.06l3-3a.75.75 0 0 0 0-1.06l-3-3a.75.75 0 0 0-1.06 0"
        clip-rule="evenodd" />
    </svg>
    <span class="nav-link">Early Leave</span>
  </li>


  <li class="nav-item" role="presentation" [ngClass]="{
        'active': currentStep === 3
    }" (click)="goToStep(3)" (keydown)="handleTabKeydown($event)" [attr.aria-selected]="currentStep === 3"
    [attr.tabindex]="currentStep === 3 ? '0' : '-1'" role="tab" id="tab-3" aria-controls="panel-3"
    aria-label="Step 3: Absence" style="cursor: pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M4.929 4.929c-3.905 3.905-3.905 10.237 0 14.142s10.237 3.905 14.142 0s3.905-10.237 0-14.142s-10.237-3.905-14.142 0"
        opacity=".5" />
      <path d="M18.521 4.418L4.418 18.521a10 10 0 0 0 1.06 1.061L19.583 5.479a10 10 0 0 0-1.06-1.06" />
    </svg>
    <span class="nav-link">Absence</span>
  </li>

  <li class="nav-item" role="presentation" [ngClass]="{
        'active': currentStep === 4
    }" (click)="goToStep(4)" (keydown)="handleTabKeydown($event)" [attr.aria-selected]="currentStep === 4"
    [attr.tabindex]="currentStep === 4 ? '0' : '-1'" role="tab" id="tab-4" aria-controls="panel-4"
    aria-label="Step 4: Overtime" style="cursor: pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10s10-4.5 10-10S17.5 2 12 2m0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8s8 3.6 8 8s-3.6 8-8 8" />
      <path d="M12.5 7H11v6l5.2 3.2l.8-1.3l-4.5-2.7V7z" />
    </svg>
    <span class="nav-link">Overtime</span>
  </li>

  <li class="nav-item" role="presentation" [ngClass]="{
        'active': currentStep === 5
    }" (click)="goToStep(5)" (keydown)="handleTabKeydown($event)" [attr.aria-selected]="currentStep === 5"
    [attr.tabindex]="currentStep === 5 ? '0' : '-1'" role="tab" id="tab-5" aria-controls="panel-5"
    aria-label="Step 5: Grace Period" style="cursor: pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M2 12c0-4.714 0-7.071 1.464-8.536C4.93 2 7.286 2 12 2s7.071 0 8.535 1.464C22 4.93 22 7.286 22 12s0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12"
        opacity=".5" />
      <path fill-rule="evenodd"
        d="M6.914 11.25H2v1.5h8.163A3.25 3.25 0 0 1 7 15.25a.75.75 0 0 0 0 1.5a4.75 4.75 0 0 0 4.25-2.626V22h1.5v-7.876A4.75 4.75 0 0 0 17 16.75a.75.75 0 0 0 0-1.5a3.25 3.25 0 0 1-3.163-2.5H22v-1.5h-4.913c.35-.438.613-.955.756-1.527c.538-2.153-1.413-4.103-3.565-3.565a4 4 0 0 0-1.528.756V2h-1.5v4.914a4 4 0 0 0-1.527-.756C7.57 5.62 5.62 7.57 6.158 9.723c.143.572.405 1.089.756 1.527m4.336 0H9.997a2.5 2.5 0 0 1-2.384-1.891A1.44 1.44 0 0 1 9.36 7.613a2.5 2.5 0 0 1 1.891 2.384zm2.753 0H12.75v-1.245a2.5 2.5 0 0 1 1.891-2.392a1.44 1.44 0 0 1 1.746 1.746a2.5 2.5 0 0 1-2.384 1.891"
        clip-rule="evenodd" />
    </svg>
    <span class="nav-link">Grace Period</span>
  </li>
</ul>



<!-- Lateness -->
@if (currentStep === 1) {
<div class="content-hug" role="tabpanel" id="panel-1" aria-labelledby="tab-1" [attr.aria-hidden]="currentStep !== 1">
  <div class="content-box d-flex flex-column gap-3">

    <h2>Lateness</h2>
    <div class="lateness-table-wrapper">
      <div class="lateness-table">
        <!-- Table Header -->
        <div class="lateness-table-header">
          <div class="lateness-header-cell" style="width: 48px;"></div>
          <div class="lateness-header-cell flex-grow-1">Occurrence</div>
          <div class="lateness-header-cell" style="width: 200px;">Threshold Time</div>
          <div class="lateness-header-cell" style="width: 200px;">Deduction Value</div>
          <div class="lateness-header-cell flex-grow-1">Deduction Base</div>
          <div class="lateness-header-cell" style="width: 48px;"></div>
        </div>

        <!-- Table Content -->
        <div class="lateness-table-content">
          @if (loading || salaryPortionsLoading) {
          @for (i of [1, 2, 3]; track i) {
          <div class="lateness-table-row">
            <div class="lateness-table-cell" style="width: 48px;"></div>
            <div class="lateness-table-cell flex-grow-1">
              <div class="skeleton-block h-4 w-75"></div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="skeleton-block h-4 w-100"></div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="skeleton-block h-4 w-100"></div>
            </div>
            <div class="lateness-table-cell flex-grow-1">
              <div class="skeleton-block h-4 w-100"></div>
            </div>
            <div class="lateness-table-cell" style="width: 48px;"></div>
          </div>
          }
          } @else {
          @for (occurrence of latenessOccurrences; track $index; let occurrenceIndex = $index) {
          <!-- Occurrence Row (Expandable) -->
          <div class="lateness-table-row occurrence-row" [class.expanded]="occurrence.isExpanded"
            [class.has-rules]="occurrence.isExpanded && occurrence.deductionRules.length > 0">
            <div class="lateness-table-cell expand-icon-cell" style="width: 48px;">
              <button type="button" class="expand-toggle-btn" (click)="toggleOccurrenceExpanded(occurrenceIndex)"
                [attr.aria-expanded]="occurrence.isExpanded"
                [attr.aria-label]="(occurrence.isExpanded ? 'Collapse' : 'Expand') + ' ' + getOccurrenceLabel(occurrenceIndex)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                  [class.rotated]="occurrence.isExpanded">
                  <path fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" d="M8 10l4 4 4-4" />
                </svg>
              </button>
            </div>
            <div class="lateness-table-cell occurrence-cell flex-grow-1">
              <span class="occurrence-label">{{ getOccurrenceLabel(occurrenceIndex) }}</span>
            </div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell flex-grow-1"></div>
            <div class="lateness-table-cell actions-cell" style="width: 48px;">
              @if (latenessOccurrences.length > 1) {
              <button type="button" (click)="removeLatenessOccurrence(occurrenceIndex)" class="btn-icon-remove"
                [attr.aria-label]="'Remove ' + getOccurrenceLabel(occurrenceIndex) + ' occurrence'"
                title="Remove {{ getOccurrenceLabel(occurrenceIndex) }} occurrence">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                  <path fill="currentColor"
                    d="M12 2.75a2.25 2.25 0 0 0-2.122 1.5a.75.75 0 0 1-1.414-.5a3.751 3.751 0 0 1 7.073 0a.75.75 0 0 1-1.415.5A2.25 2.25 0 0 0 12 2.75M2.75 6a.75.75 0 0 1 .75-.75h17a.75.75 0 0 1 0 1.5h-17A.75.75 0 0 1 2.75 6m3.165 2.45a.75.75 0 1 0-1.497.1l.464 6.952c.085 1.282.154 2.318.316 3.132c.169.845.455 1.551 1.047 2.104s1.315.793 2.17.904c.822.108 1.86.108 3.146.108h.879c1.285 0 2.324 0 3.146-.108c.854-.111 1.578-.35 2.17-.904c.591-.553.877-1.26 1.046-2.104c.162-.814.23-1.85.316-3.132l.464-6.952a.75.75 0 0 0-1.497-.1l-.46 6.9c-.09 1.347-.154 2.285-.294 2.99c-.137.685-.327 1.047-.6 1.303c-.274.256-.648.422-1.34.512c-.713.093-1.653.095-3.004.095h-.774c-1.35 0-2.29-.002-3.004-.095c-.692-.09-1.066-.256-1.34-.512c-.273-.256-.463-.618-.6-1.303c-.14-.705-.204-1.643-.294-2.99z" />
                  <path fill="currentColor"
                    d="M9.425 10.254a.75.75 0 0 1 .821.671l.5 5a.75.75 0 0 1-1.492.15l-.5-5a.75.75 0 0 1 .671-.821m5.821.821a.75.75 0 0 0-1.492-.15l-.5 5a.75.75 0 0 0 1.492.15z" />
                </svg>
              </button>
              }
            </div>
          </div>

          <!-- Deduction Rules (shown when expanded) -->
          @if (occurrence.isExpanded) {
          @for (rule of occurrence.deductionRules; track $index; let ruleIndex = $index) {
          <div class="lateness-table-row deduction-rule-row" [class.alt-row]="ruleIndex % 2 === 1"
            [class.last-rule]="ruleIndex === occurrence.deductionRules.length - 1">
            <div class="lateness-table-cell expand-icon-cell" style="width: 48px;">
              <svg class="connecting-line-svg" width="64" height="48" viewBox="0 0 64 48" fill="none"
                xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                <path d="M64 24H30C26.6863 24 24 21.3137 24 18V0" stroke="#4A6D97" stroke-width="1.5" />
                <path d="M24 48V32.9143V0" stroke="#4A6D97" stroke-width="1.5" />
              </svg>
            </div>
            <div class="lateness-table-cell occurrence-cell flex-grow-1">
              <div class="deduction-rule-label">
                Deduction Rule #{{ ruleIndex + 1 }}
              </div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="w-100">
                <label [for]="'lateness-threshold-' + occurrenceIndex + '-' + ruleIndex" class="visually-hidden">
                  Threshold time for {{ getOccurrenceLabel(occurrenceIndex) }} rule {{ ruleIndex + 1
                  }}
                </label>
                <input type="number" [id]="'lateness-threshold-' + occurrenceIndex + '-' + ruleIndex"
                  [(ngModel)]="rule.thresholdTime" class="form-control table-input"
                  [class.is-invalid]="latenessValidationErrors[occurrenceIndex][ruleIndex].thresholdTime"
                  (input)="clearLatenessValidationError(occurrenceIndex, ruleIndex, 'thresholdTime')"
                  [attr.aria-invalid]="latenessValidationErrors[occurrenceIndex][ruleIndex].thresholdTime"
                  placeholder="Enter Minutes" [ngModelOptions]="{ standalone: true }" />
                @if (latenessValidationErrors[occurrenceIndex][ruleIndex].thresholdTime) {
                <div class="invalid-feedback d-block" role="alert">
                  Threshold time is required
                </div>
                }
              </div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="w-100">
                <label [for]="'lateness-value-' + occurrenceIndex + '-' + ruleIndex" class="visually-hidden">
                  Deduction value for {{ getOccurrenceLabel(occurrenceIndex) }} rule {{ ruleIndex + 1
                  }}
                </label>
                <input type="number" [id]="'lateness-value-' + occurrenceIndex + '-' + ruleIndex"
                  [(ngModel)]="rule.deductionValue" class="form-control table-input"
                  [class.is-invalid]="latenessValidationErrors[occurrenceIndex][ruleIndex].deductionValue"
                  (input)="clearLatenessValidationError(occurrenceIndex, ruleIndex, 'deductionValue')"
                  [attr.aria-invalid]="latenessValidationErrors[occurrenceIndex][ruleIndex].deductionValue"
                  placeholder="Enter Value in days" [ngModelOptions]="{ standalone: true }" />
                @if (latenessValidationErrors[occurrenceIndex][ruleIndex].deductionValue) {
                <div class="invalid-feedback d-block" role="alert">
                  Deduction value is required
                </div>
                }
              </div>
            </div>
            <div class="lateness-table-cell flex-grow-1">
              <div class="w-100">
                <label [for]="'lateness-base-' + occurrenceIndex + '-' + ruleIndex" class="visually-hidden">
                  Deduction base for {{ getOccurrenceLabel(occurrenceIndex) }} rule {{ ruleIndex + 1
                  }}
                </label>
                <select [id]="'lateness-base-' + occurrenceIndex + '-' + ruleIndex" [(ngModel)]="rule.deductionBase"
                  class="form-select table-input"
                  [class.is-invalid]="latenessValidationErrors[occurrenceIndex][ruleIndex].deductionBase"
                  (change)="clearLatenessValidationError(occurrenceIndex, ruleIndex, 'deductionBase')"
                  [attr.aria-invalid]="latenessValidationErrors[occurrenceIndex][ruleIndex].deductionBase"
                  [ngModelOptions]="{ standalone: true }">
                  <option [value]="null">Select Salary Portion</option>
                  @for (portion of salaryPortions; track portion.index) {
                  <option [ngValue]="portion.index">
                    @if (shouldShowPercentage(portion.percentage)) {
                    {{ portion.name }} ({{ portion.percentage }}%)
                    } @else {
                    {{ portion.name }}
                    }
                  </option>
                  }
                </select>
                @if (latenessValidationErrors[occurrenceIndex][ruleIndex].deductionBase) {
                <div class="invalid-feedback d-block" role="alert">
                  Deduction base is required
                </div>
                }
              </div>
            </div>
            <div class="lateness-table-cell actions-cell" style="width: 48px;">
              @if (occurrence.deductionRules.length > 1) {
              <button type="button" (click)="removeLatenessDeductionRule(occurrenceIndex, ruleIndex)"
                class="btn-icon-remove"
                [attr.aria-label]="'Remove deduction rule ' + (ruleIndex + 1) + ' for ' + getOccurrenceLabel(occurrenceIndex)"
                title="Remove deduction rule">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                  <path fill="currentColor"
                    d="M12 2.75a2.25 2.25 0 0 0-2.122 1.5a.75.75 0 0 1-1.414-.5a3.751 3.751 0 0 1 7.073 0a.75.75 0 0 1-1.415.5A2.25 2.25 0 0 0 12 2.75M2.75 6a.75.75 0 0 1 .75-.75h17a.75.75 0 0 1 0 1.5h-17A.75.75 0 0 1 2.75 6m3.165 2.45a.75.75 0 1 0-1.497.1l.464 6.952c.085 1.282.154 2.318.316 3.132c.169.845.455 1.551 1.047 2.104s1.315.793 2.17.904c.822.108 1.86.108 3.146.108h.879c1.285 0 2.324 0 3.146-.108c.854-.111 1.578-.35 2.17-.904c.591-.553.877-1.26 1.046-2.104c.162-.814.23-1.85.316-3.132l.464-6.952a.75.75 0 0 0-1.497-.1l-.46 6.9c-.09 1.347-.154 2.285-.294 2.99c-.137.685-.327 1.047-.6 1.303c-.274.256-.648.422-1.34.512c-.713.093-1.653.095-3.004.095h-.774c-1.35 0-2.29-.002-3.004-.095c-.692-.09-1.066-.256-1.34-.512c-.273-.256-.463-.618-.6-1.303c-.14-.705-.204-1.643-.294-2.99z" />
                  <path fill="currentColor"
                    d="M9.425 10.254a.75.75 0 0 1 .821.671l.5 5a.75.75 0 0 1-1.492.15l-.5-5a.75.75 0 0 1 .671-.821m5.821.821a.75.75 0 0 0-1.492-.15l-.5 5a.75.75 0 0 0 1.492.15z" />
                </svg>
              </button>
              }
            </div>
          </div>
          }
          <!-- Add Deduction Rule Button -->
          <div class="lateness-table-row add-rule-row">
            <div class="lateness-table-cell expand-icon-cell" style="width: 48px;">
              <svg class="connecting-line-svg" width="64" height="48" viewBox="0 0 64 48" fill="none"
                xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                <path d="M64 24H30C26.6863 24 24 21.3137 24 18V0" stroke="#4A6D97" stroke-width="1.5" />
                <path d="M24 24.75V0" stroke="#4A6D97" stroke-width="1.5" stroke-linecap="butt" />
              </svg>
            </div>
            <div class="lateness-table-cell add-rule-cell flex-grow-1">
              <button type="button" (click)="addLatenessDeductionRule(occurrenceIndex)"
                class="btn-add-rule d-flex align-items-center gap-1"
                [attr.aria-label]="'Add deduction rule for ' + getOccurrenceLabel(occurrenceIndex)">
                <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M8.625 5.8125C8.625 5.50184 8.37316 5.25 8.0625 5.25C7.75184 5.25 7.5 5.50184 7.5 5.8125L7.5 7.50002H5.8125C5.50184 7.50002 5.25 7.75186 5.25 8.06252C5.25 8.37318 5.50184 8.62502 5.8125 8.62502H7.5V10.3125C7.5 10.6232 7.75184 10.875 8.0625 10.875C8.37316 10.875 8.625 10.6232 8.625 10.3125L8.625 8.62502H10.3125C10.6232 8.62502 10.875 8.37318 10.875 8.06252C10.875 7.75186 10.6232 7.50002 10.3125 7.50002H8.625V5.8125Z"
                    fill="#377AFD" />
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M8.0625 0C3.6097 0 0 3.6097 0 8.0625C0 12.5153 3.6097 16.125 8.0625 16.125C12.5153 16.125 16.125 12.5153 16.125 8.0625C16.125 3.6097 12.5153 0 8.0625 0ZM1.125 8.0625C1.125 4.23102 4.23102 1.125 8.0625 1.125C11.894 1.125 15 4.23102 15 8.0625C15 11.894 11.894 15 8.0625 15C4.23102 15 1.125 11.894 1.125 8.0625Z"
                    fill="#377AFD" />
                </svg>

                <span>Add Deduction Rule</span>
              </button>
            </div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell flex-grow-1"></div>
            <div class="lateness-table-cell" style="width: 48px;"></div>
          </div>
          }
          }
          }
        </div>

        <!-- Add Occurrence Button -->
        <div class="lateness-table-row add-occurrence-row">
          <div class="lateness-table-cell" style="width: 48px;"></div>
          <div class="lateness-table-cell add-occurrence-cell flex-grow-1">
            <button type="button" (click)="addLatenessOccurrence()"
              class="btn-add-occurrence d-flex align-items-center gap-1" aria-label="Add new lateness occurrence">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                <path fill="currentColor"
                  d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10s10-4.5 10-10S17.5 2 12 2m0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8s8 3.6 8 8s-3.6 8-8 8" />
                <path fill="currentColor" d="M15 12h-3v-3h-2v3H7v2h3v3h2v-3h3z" />
              </svg>
              <span>Add Occurrence</span>
            </button>
          </div>
          <div class="lateness-table-cell" style="width: 200px;"></div>
          <div class="lateness-table-cell" style="width: 200px;"></div>
          <div class="lateness-table-cell flex-grow-1"></div>
          <div class="lateness-table-cell" style="width: 48px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- Early Leave -->
@if (currentStep === 2) {
<div class="content-hug" role="tabpanel" id="panel-2" aria-labelledby="tab-2" [attr.aria-hidden]="currentStep !== 2">
  <div class="content-box d-flex flex-column gap-3">

    <h2>Early Leave</h2>
    <div class="lateness-table-wrapper">
      <div class="lateness-table">
        <!-- Table Header -->
        <div class="lateness-table-header">
          <div class="lateness-header-cell" style="width: 48px;"></div>
          <div class="lateness-header-cell flex-grow-1">Occurrence</div>
          <div class="lateness-header-cell" style="width: 200px;">Threshold Time</div>
          <div class="lateness-header-cell" style="width: 200px;">Deduction Value</div>
          <div class="lateness-header-cell flex-grow-1">Deduction Base</div>
          <div class="lateness-header-cell" style="width: 48px;"></div>
        </div>

        <!-- Table Content -->
        <div class="lateness-table-content">
          @if (loading || salaryPortionsLoading) {
          @for (i of [1, 2, 3]; track i) {
          <div class="lateness-table-row">
            <div class="lateness-table-cell" style="width: 48px;"></div>
            <div class="lateness-table-cell flex-grow-1">
              <div class="skeleton-block h-4 w-75"></div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="skeleton-block h-4 w-100"></div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="skeleton-block h-4 w-100"></div>
            </div>
            <div class="lateness-table-cell flex-grow-1">
              <div class="skeleton-block h-4 w-100"></div>
            </div>
            <div class="lateness-table-cell" style="width: 48px;"></div>
          </div>
          }
          } @else {
          @for (occurrence of earlyLeaveOccurrences; track $index; let occurrenceIndex = $index) {
          <!-- Occurrence Row (Expandable) -->
          <div class="lateness-table-row occurrence-row" [class.expanded]="occurrence.isExpanded"
            [class.has-rules]="occurrence.isExpanded && occurrence.deductionRules.length > 0">
            <div class="lateness-table-cell expand-icon-cell" style="width: 48px;">
              <button type="button" class="expand-toggle-btn"
                (click)="toggleEarlyLeaveOccurrenceExpanded(occurrenceIndex)"
                [attr.aria-expanded]="occurrence.isExpanded"
                [attr.aria-label]="(occurrence.isExpanded ? 'Collapse' : 'Expand') + ' ' + getOccurrenceLabel(occurrenceIndex)">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                  [class.rotated]="occurrence.isExpanded">
                  <path fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" d="M8 10l4 4 4-4" />
                </svg>
              </button>
            </div>
            <div class="lateness-table-cell occurrence-cell flex-grow-1">
              <span class="occurrence-label">{{ getOccurrenceLabel(occurrenceIndex) }}</span>
            </div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell flex-grow-1"></div>
            <div class="lateness-table-cell actions-cell" style="width: 48px;">
              @if (earlyLeaveOccurrences.length > 1) {
              <button type="button" (click)="removeEarlyLeaveOccurrence(occurrenceIndex)" class="btn-icon-remove"
                [attr.aria-label]="'Remove ' + getOccurrenceLabel(occurrenceIndex) + ' occurrence'"
                title="Remove {{ getOccurrenceLabel(occurrenceIndex) }} occurrence">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                  <path fill="currentColor"
                    d="M12 2.75a2.25 2.25 0 0 0-2.122 1.5a.75.75 0 0 1-1.414-.5a3.751 3.751 0 0 1 7.073 0a.75.75 0 0 1-1.415.5A2.25 2.25 0 0 0 12 2.75M2.75 6a.75.75 0 0 1 .75-.75h17a.75.75 0 0 1 0 1.5h-17A.75.75 0 0 1 2.75 6m3.165 2.45a.75.75 0 1 0-1.497.1l.464 6.952c.085 1.282.154 2.318.316 3.132c.169.845.455 1.551 1.047 2.104s1.315.793 2.17.904c.822.108 1.86.108 3.146.108h.879c1.285 0 2.324 0 3.146-.108c.854-.111 1.578-.35 2.17-.904c.591-.553.877-1.26 1.046-2.104c.162-.814.23-1.85.316-3.132l.464-6.952a.75.75 0 0 0-1.497-.1l-.46 6.9c-.09 1.347-.154 2.285-.294 2.99c-.137.685-.327 1.047-.6 1.303c-.274.256-.648.422-1.34.512c-.713.093-1.653.095-3.004.095h-.774c-1.35 0-2.29-.002-3.004-.095c-.692-.09-1.066-.256-1.34-.512c-.273-.256-.463-.618-.6-1.303c-.14-.705-.204-1.643-.294-2.99z" />
                  <path fill="currentColor"
                    d="M9.425 10.254a.75.75 0 0 1 .821.671l.5 5a.75.75 0 0 1-1.492.15l-.5-5a.75.75 0 0 1 .671-.821m5.821.821a.75.75 0 0 0-1.492-.15l-.5 5a.75.75 0 0 0 1.492.15z" />
                </svg>
              </button>
              }
            </div>
          </div>

          <!-- Deduction Rules (shown when expanded) -->
          @if (occurrence.isExpanded) {
          @for (rule of occurrence.deductionRules; track $index; let ruleIndex = $index) {
          <div class="lateness-table-row deduction-rule-row" [class.alt-row]="ruleIndex % 2 === 1"
            [class.last-rule]="ruleIndex === occurrence.deductionRules.length - 1">
            <div class="lateness-table-cell expand-icon-cell" style="width: 48px;">
              <svg class="connecting-line-svg" width="64" height="48" viewBox="0 0 64 48" fill="none"
                xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                <path d="M64 24H30C26.6863 24 24 21.3137 24 18V0" stroke="#4A6D97" stroke-width="1.5" />
                <path d="M24 48V32.9143V0" stroke="#4A6D97" stroke-width="1.5" />
              </svg>
            </div>
            <div class="lateness-table-cell occurrence-cell flex-grow-1">
              <div class="deduction-rule-label">
                Deduction Rule #{{ ruleIndex + 1 }}
              </div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="w-100">
                <label [for]="'earlyleave-threshold-' + occurrenceIndex + '-' + ruleIndex" class="visually-hidden">
                  Threshold time for {{ getOccurrenceLabel(occurrenceIndex) }} rule {{ ruleIndex + 1
                  }}
                </label>
                <input type="number" [id]="'earlyleave-threshold-' + occurrenceIndex + '-' + ruleIndex"
                  [(ngModel)]="rule.thresholdTime" class="form-control table-input"
                  [class.is-invalid]="earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].thresholdTime"
                  (input)="clearEarlyLeaveValidationError(occurrenceIndex, ruleIndex, 'thresholdTime')"
                  [attr.aria-invalid]="earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].thresholdTime"
                  placeholder="Enter Minutes" [ngModelOptions]="{ standalone: true }" />
                @if (earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].thresholdTime) {
                <div class="invalid-feedback d-block" role="alert">
                  Threshold time is required
                </div>
                }
              </div>
            </div>
            <div class="lateness-table-cell" style="width: 200px;">
              <div class="w-100">
                <label [for]="'earlyleave-value-' + occurrenceIndex + '-' + ruleIndex" class="visually-hidden">
                  Deduction value for {{ getOccurrenceLabel(occurrenceIndex) }} rule {{ ruleIndex + 1
                  }}
                </label>
                <input type="number" [id]="'earlyleave-value-' + occurrenceIndex + '-' + ruleIndex"
                  [(ngModel)]="rule.deductionValue" class="form-control table-input"
                  [class.is-invalid]="earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].deductionValue"
                  (input)="clearEarlyLeaveValidationError(occurrenceIndex, ruleIndex, 'deductionValue')"
                  [attr.aria-invalid]="earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].deductionValue"
                  placeholder="Enter Value in days" [ngModelOptions]="{ standalone: true }" />
                @if (earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].deductionValue) {
                <div class="invalid-feedback d-block" role="alert">
                  Deduction value is required
                </div>
                }
              </div>
            </div>
            <div class="lateness-table-cell flex-grow-1">
              <div class="w-100">
                <label [for]="'earlyleave-base-' + occurrenceIndex + '-' + ruleIndex" class="visually-hidden">
                  Deduction base for {{ getOccurrenceLabel(occurrenceIndex) }} rule {{ ruleIndex + 1
                  }}
                </label>
                <select [id]="'earlyleave-base-' + occurrenceIndex + '-' + ruleIndex" [(ngModel)]="rule.deductionBase"
                  class="form-select table-input"
                  [class.is-invalid]="earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].deductionBase"
                  (change)="clearEarlyLeaveValidationError(occurrenceIndex, ruleIndex, 'deductionBase')"
                  [attr.aria-invalid]="earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].deductionBase"
                  [ngModelOptions]="{ standalone: true }">
                  <option [value]="null">Select Salary Portion</option>
                  @for (portion of salaryPortions; track portion.index) {
                  <option [ngValue]="portion.index">
                    @if (shouldShowPercentage(portion.percentage)) {
                    {{ portion.name }} ({{ portion.percentage }}%)
                    } @else {
                    {{ portion.name }}
                    }
                  </option>
                  }
                </select>
                @if (earlyLeaveValidationErrors[occurrenceIndex][ruleIndex].deductionBase) {
                <div class="invalid-feedback d-block" role="alert">
                  Deduction base is required
                </div>
                }
              </div>
            </div>
            <div class="lateness-table-cell actions-cell" style="width: 48px;">
              @if (occurrence.deductionRules.length > 1) {
              <button type="button" (click)="removeEarlyLeaveDeductionRule(occurrenceIndex, ruleIndex)"
                class="btn-icon-remove"
                [attr.aria-label]="'Remove deduction rule ' + (ruleIndex + 1) + ' for ' + getOccurrenceLabel(occurrenceIndex)"
                title="Remove deduction rule">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                  <path fill="currentColor"
                    d="M12 2.75a2.25 2.25 0 0 0-2.122 1.5a.75.75 0 0 1-1.414-.5a3.751 3.751 0 0 1 7.073 0a.75.75 0 0 1-1.415.5A2.25 2.25 0 0 0 12 2.75M2.75 6a.75.75 0 0 1 .75-.75h17a.75.75 0 0 1 0 1.5h-17A.75.75 0 0 1 2.75 6m3.165 2.45a.75.75 0 1 0-1.497.1l.464 6.952c.085 1.282.154 2.318.316 3.132c.169.845.455 1.551 1.047 2.104s1.315.793 2.17.904c.822.108 1.86.108 3.146.108h.879c1.285 0 2.324 0 3.146-.108c.854-.111 1.578-.35 2.17-.904c.591-.553.877-1.26 1.046-2.104c.162-.814.23-1.85.316-3.132l.464-6.952a.75.75 0 0 0-1.497-.1l-.46 6.9c-.09 1.347-.154 2.285-.294 2.99c-.137.685-.327 1.047-.6 1.303c-.274.256-.648.422-1.34.512c-.713.093-1.653.095-3.004.095h-.774c-1.35 0-2.29-.002-3.004-.095c-.692-.09-1.066-.256-1.34-.512c-.273-.256-.463-.618-.6-1.303c-.14-.705-.204-1.643-.294-2.99z" />
                  <path fill="currentColor"
                    d="M9.425 10.254a.75.75 0 0 1 .821.671l.5 5a.75.75 0 0 1-1.492.15l-.5-5a.75.75 0 0 1 .671-.821m5.821.821a.75.75 0 0 0-1.492-.15l-.5 5a.75.75 0 0 0 1.492.15z" />
                </svg>
              </button>
              }
            </div>
          </div>
          }
          <!-- Add Deduction Rule Button -->
          <div class="lateness-table-row add-rule-row">
            <div class="lateness-table-cell expand-icon-cell" style="width: 48px;">
              <svg class="connecting-line-svg" width="64" height="48" viewBox="0 0 64 48" fill="none"
                xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
                <path d="M64 24H30C26.6863 24 24 21.3137 24 18V0" stroke="#4A6D97" stroke-width="1.5" />
                <path d="M24 24.75V0" stroke="#4A6D97" stroke-width="1.5" stroke-linecap="butt" />
              </svg>
            </div>
            <div class="lateness-table-cell add-rule-cell flex-grow-1">
              <button type="button" (click)="addEarlyLeaveDeductionRule(occurrenceIndex)"
                class="btn-add-rule d-flex align-items-center gap-1"
                [attr.aria-label]="'Add deduction rule for ' + getOccurrenceLabel(occurrenceIndex)">
                <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M8.625 5.8125C8.625 5.50184 8.37316 5.25 8.0625 5.25C7.75184 5.25 7.5 5.50184 7.5 5.8125L7.5 7.50002H5.8125C5.50184 7.50002 5.25 7.75186 5.25 8.06252C5.25 8.37318 5.50184 8.62502 5.8125 8.62502H7.5V10.3125C7.5 10.6232 7.75184 10.875 8.0625 10.875C8.37316 10.875 8.625 10.6232 8.625 10.3125L8.625 8.62502H10.3125C10.6232 8.62502 10.875 8.37318 10.875 8.06252C10.875 7.75186 10.6232 7.50002 10.3125 7.50002H8.625V5.8125Z"
                    fill="#377AFD" />
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M8.0625 0C3.6097 0 0 3.6097 0 8.0625C0 12.5153 3.6097 16.125 8.0625 16.125C12.5153 16.125 16.125 12.5153 16.125 8.0625C16.125 3.6097 12.5153 0 8.0625 0ZM1.125 8.0625C1.125 4.23102 4.23102 1.125 8.0625 1.125C11.894 1.125 15 4.23102 15 8.0625C15 11.894 11.894 15 8.0625 15C4.23102 15 1.125 11.894 1.125 8.0625Z"
                    fill="#377AFD" />
                </svg>

                <span>Add Deduction Rule</span>
              </button>
            </div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell" style="width: 200px;"></div>
            <div class="lateness-table-cell flex-grow-1"></div>
            <div class="lateness-table-cell" style="width: 48px;"></div>
          </div>
          }
          }
          }
        </div>

        <!-- Add Occurrence Button -->
        <div class="lateness-table-row add-occurrence-row">
          <div class="lateness-table-cell" style="width: 48px;"></div>
          <div class="lateness-table-cell add-occurrence-cell flex-grow-1">
            <button type="button" (click)="addEarlyLeaveOccurrence()"
              class="btn-add-occurrence d-flex align-items-center gap-1" aria-label="Add new early leave occurrence">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                <path fill="currentColor"
                  d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10s10-4.5 10-10S17.5 2 12 2m0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8s8 3.6 8 8s-3.6 8-8 8" />
                <path fill="currentColor" d="M15 12h-3v-3h-2v3H7v2h3v3h2v-3h3z" />
              </svg>
              <span>Add Occurrence</span>
            </button>
          </div>
          <div class="lateness-table-cell" style="width: 200px;"></div>
          <div class="lateness-table-cell" style="width: 200px;"></div>
          <div class="lateness-table-cell flex-grow-1"></div>
          <div class="lateness-table-cell" style="width: 48px;"></div>
        </div>
      </div>
    </div>

  </div>
</div>
}

<!-- Absence -->
@if (currentStep === 3) {
<div class="content-hug" role="tabpanel" id="panel-3" aria-labelledby="tab-3" [attr.aria-hidden]="currentStep !== 3">
  <div class="content-box d-flex flex-column gap-3">
    <h2>Absence</h2>
    <div class="table-responsive">
      <table class="table table-hover align-middle" role="table" aria-label="Absence entries">
        <thead>
          <tr>
            <th class="w-20" scope="col">Occurrence</th>
            <th class="w-35" scope="col">Deduction Value</th>
            <th class="w-40" scope="col">Salary Portion</th>
            <th class="w-5" scope="col"><span class="visually-hidden">Actions</span></th>
          </tr>
        </thead>
        <tbody>
          @if (loading || salaryPortionsLoading) {
          @for (i of [1, 2, 3]; track i) {
          <tr>
            <td>
              <div class="skeleton-block h-4 w-75"></div>
            </td>
            <td>
              <div class="skeleton-block h-4 w-100"></div>
            </td>
            <td>
              <div class="skeleton-block h-4 w-100"></div>
            </td>
            <td></td>
          </tr>
          }
          } @else {
          @for (entry of absenceEntries; track entry; let i = $index) {
          <tr>
            <td>{{ getOccurrenceLabel(i) }}</td>
            <td>
              <div class="w-100">
                <label [for]="'absence-value-' + i" class="visually-hidden">
                  Deduction value for {{ getOccurrenceLabel(i) }}
                </label>
                <input type="number" [id]="'absence-value-' + i" [(ngModel)]="entry.value"
                  class="form-control table-input" [class.is-invalid]="absenceValidationErrors[i].value"
                  (input)="clearAbsenceValidationError(i, 'value')"
                  [attr.aria-invalid]="absenceValidationErrors[i].value"
                  [attr.aria-describedby]="absenceValidationErrors[i].value ? 'absence-value-error-' + i : null"
                  placeholder="Enter Value in days"
                  [attr.aria-label]="'Deduction value for ' + getOccurrenceLabel(i)" />
                @if (absenceValidationErrors[i].value) {
                <div class="invalid-feedback d-block" [id]="'absence-value-error-' + i" role="alert">
                  Deduction value is required
                </div>
                }
              </div>
            </td>
            <td>
              <div class="w-100">
                <label [for]="'absence-salary-' + i" class="visually-hidden">
                  Salary portion for {{ getOccurrenceLabel(i) }}
                </label>
                <select [id]="'absence-salary-' + i" [(ngModel)]="entry.salaryPortionIndex"
                  class="form-select table-input" [class.is-invalid]="absenceValidationErrors[i].salaryPortion"
                  (change)="clearAbsenceValidationError(i, 'salaryPortion')"
                  [attr.aria-invalid]="absenceValidationErrors[i].salaryPortion"
                  [attr.aria-describedby]="absenceValidationErrors[i].salaryPortion ? 'absence-salary-error-' + i : null"
                  [attr.aria-label]="'Salary portion for ' + getOccurrenceLabel(i)" [attr.aria-required]="true"
                  [disabled]="!entry.value && entry.value !== 0" [ngModelOptions]="{ standalone: true }">
                  <option [value]="null" [disabled]="entry.value != null && entry.value !== 0">Select Salary Portion
                  </option>
                  @for (portion of salaryPortions; track portion.index) {
                  <option [ngValue]="portion.index">
                    @if (shouldShowPercentage(portion.percentage)) {
                    {{ portion.name }} ({{ portion.percentage }}%)
                    } @else {
                    {{ portion.name }}
                    }
                  </option>
                  }
                </select>
                @if (absenceValidationErrors[i].salaryPortion) {
                <div class="invalid-feedback d-block" [id]="'absence-salary-error-' + i" role="alert">
                  Salary portion is required
                </div>
                }
              </div>
            </td>
            <td>
              @if (absenceEntries.length > 1) {
              <button type="button" (click)="removeAbsenceRow(i)" (keydown.enter)="removeAbsenceRow(i)"
                (keydown.space)="removeAbsenceRow(i); $event.preventDefault()" class="btn btn-remove p-0 text-lg"
                [attr.aria-label]="'Remove ' + getOccurrenceLabel(i) + ' entry'"
                title="Remove {{ getOccurrenceLabel(i) }} entry">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" aria-hidden="true">
                  <path fill="#4A6D97"
                    d="M12 2.75a2.25 2.25 0 0 0-2.122 1.5a.75.75 0 0 1-1.414-.5a3.751 3.751 0 0 1 7.073 0a.75.75 0 0 1-1.415.5A2.25 2.25 0 0 0 12 2.75M2.75 6a.75.75 0 0 1 .75-.75h17a.75.75 0 0 1 0 1.5h-17A.75.75 0 0 1 2.75 6m3.165 2.45a.75.75 0 1 0-1.497.1l.464 6.952c.085 1.282.154 2.318.316 3.132c.169.845.455 1.551 1.047 2.104s1.315.793 2.17.904c.822.108 1.86.108 3.146.108h.879c1.285 0 2.324 0 3.146-.108c.854-.111 1.578-.35 2.17-.904c.591-.553.877-1.26 1.046-2.104c.162-.814.23-1.85.316-3.132l.464-6.952a.75.75 0 0 0-1.497-.1l-.46 6.9c-.09 1.347-.154 2.285-.294 2.99c-.137.685-.327 1.047-.6 1.303c-.274.256-.648.422-1.34.512c-.713.093-1.653.095-3.004.095h-.774c-1.35 0-2.29-.002-3.004-.095c-.692-.09-1.066-.256-1.34-.512c-.273-.256-.463-.618-.6-1.303c-.14-.705-.204-1.643-.294-2.99z" />
                  <path fill="#4A6D97"
                    d="M9.425 10.254a.75.75 0 0 1 .821.671l.5 5a.75.75 0 0 1-1.492.15l-.5-5a.75.75 0 0 1 .671-.821m5.821.821a.75.75 0 0 0-1.492-.15l-.5 5a.75.75 0 0 0 1.492.15z" />
                </svg>
                <span class="visually-hidden">Remove {{ getOccurrenceLabel(i) }} entry</span>
              </button>
              }
            </td>
          </tr>
          }
          }
        </tbody>
      </table>
    </div>
    <div class="mt-3">
      <button type="button" (click)="addAbsenceRow()" (keydown.enter)="addAbsenceRow()"
        (keydown.space)="addAbsenceRow(); $event.preventDefault()"
        class="view-btn add-sec d-flex align-items-center gap-1" aria-label="Add new absence occurrence">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <g fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10" />
            <path stroke-linecap="round" d="M15 12h-3m0 0H9m3 0V9m0 3v3" />
          </g>
        </svg>
        <span>Add Occurrence</span>
      </button>
    </div>
  </div>
</div>
}

<!-- Overtime -->
@if (currentStep === 4) {
<div class="content-hug">
  <div class="content-box d-flex flex-column gap-3">
    <h2>Overtime</h2>

    <!-- Allow Overtime Checkbox -->
    <div class="form-check d-flex align-items-end justify-content-start p-0 m-0 gap-3">
      <input class="form-check-input m-0" type="checkbox" id="allowOvertime" [(ngModel)]="allowOvertime"
        [ngModelOptions]="{ standalone: true }" />
      <label class="form-check-label m-0" for="allowOvertime">
        Allow Overtime
      </label>
    </div>

    <!-- Overtime Options -->
    <div class="d-flex flex-column gap-3" [style.opacity]="allowOvertime ? '1' : '0.5'">
      <!-- Radio Button Options -->
      <div class="d-flex align-items-center gap-3">
        <!-- Flat Rate Option -->
        <div class="d-flex align-items-center gap-2">
          <input class="form-check-input radio" type="radio" name="overtimeType" id="flatRate"
            [(ngModel)]="overtimeType" value="flatRate" [ngModelOptions]="{ standalone: true }"
            [disabled]="!allowOvertime" />
          <label class="form-check-label m-0" for="flatRate">
            Flat Rate
          </label>
        </div>

        <!-- Custom Hours Option -->
        <!-- <div class="d-flex align-items-center gap-2">
          <input class="form-check-input radio" type="radio" name="overtimeType" id="customHours"
            [(ngModel)]="overtimeType" value="customHours" [ngModelOptions]="{ standalone: true }"
            [disabled]="!allowOvertime" />
          <label class="form-check-label m-0" for="customHours">
            Custom Hours
          </label>
        </div> -->
      </div>

      <!-- Flat Rate Input -->
      @if (overtimeType === 'flatRate') {
      <div class="d-flex gap-3 flex-wrap">
        <div class="input flex-fill" style="min-width: 200px;">
          <label for="flatRateValue">Flat Rate</label>
          <div class="form-outline w-100 position-relative custom-date-wrapper">
            <input type="text" class="form-control custom-date-input" id="flatRateValue" placeholder="Per Hour"
              [(ngModel)]="flatRateValue" [ngModelOptions]="{ standalone: true }" [disabled]="!allowOvertime" />
          </div>
        </div>
        <div class="input flex-fill" style="min-width: 250px;">
          <label for="flatRateSalaryPortion">Salary Portion</label>
          <div class="form-outline w-100 position-relative">
            <select id="flatRateSalaryPortion" [(ngModel)]="flatRateSalaryPortionIndex" class="form-select"
              [disabled]="!allowOvertime || !flatRateValue" [ngModelOptions]="{ standalone: true }">
              <option [ngValue]="null" [disabled]="flatRateValue">Select Salary Portion</option>
              @for (portion of salaryPortions; track portion.index) {
              <option [ngValue]="portion.index">
                {{ portion.name }} ({{ portion.percentage }}%)
              </option>
              }
            </select>
          </div>
        </div>
      </div>
      }

      <!-- Custom Hours Table -->
      @if (overtimeType === 'customHours') {
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th style="width: 8%;">ID</th>
              <th style="width: 20%;">From</th>
              <th style="width: 20%;">To</th>
              <th style="width: 18%;">Rate</th>
              <!-- <th style="width: 28%;">Salary Portion</th> -->
              <th style="width: 6%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (entry of overtimeEntries; track $index) {
            <tr>
              <td>{{ ($index + 1).toString().padStart(3, '0') }}</td>
              <td>
                <input type="time" class="form-control" [(ngModel)]="entry.from" [ngModelOptions]="{ standalone: true }"
                  [disabled]="!allowOvertime" />
              </td>
              <td>
                <input type="time" class="form-control" [(ngModel)]="entry.to" [ngModelOptions]="{ standalone: true }"
                  [disabled]="!allowOvertime" />
              </td>
              <td>
                <input type="number" class="form-control" placeholder="1.00" step="0.01" [(ngModel)]="entry.rate"
                  [ngModelOptions]="{ standalone: true }" [disabled]="!allowOvertime" />
              </td>
              <!-- <td>
                <select [(ngModel)]="entry.salaryPortionIndex" class="form-select"
                  [disabled]="!allowOvertime || entry.rate == null || entry.rate === 0"
                  [ngModelOptions]="{ standalone: true }">
                  <option [ngValue]="null" [disabled]="entry.rate != null && entry.rate !== 0">Select Salary Portion
                  </option>
                  @for (portion of salaryPortions; track portion.index) {
                  <option [ngValue]="portion.index">
                    @if (shouldShowPercentage(portion.percentage)) {
                      {{ portion.name }} ({{ portion.percentage }}%)
                    } @else {
                      {{ portion.name }}
                    }
                  </option>
                  }
                </select>
              </td> -->
              <td>
                @if (overtimeEntries.length > 1) {
                <button type="button" class="btn btn-remove p-0 text-lg" (click)="removeOvertimeRow($index)"
                  aria-label="Remove section" [disabled]="!allowOvertime">
                  <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24">
                    <path fill="#4A6D97"
                      d="M12 2.75a2.25 2.25 0 0 0-2.122 1.5a.75.75 0 0 1-1.414-.5a3.751 3.751 0 0 1 7.073 0a.75.75 0 0 1-1.415.5A2.25 2.25 0 0 0 12 2.75M2.75 6a.75.75 0 0 1 .75-.75h17a.75.75 0 0 1 0 1.5h-17A.75.75 0 0 1 2.75 6m3.165 2.45a.75.75 0 1 0-1.497.1l.464 6.952c.085 1.282.154 2.318.316 3.132c.169.845.455 1.551 1.047 2.104s1.315.793 2.17.904c.822.108 1.86.108 3.146.108h.879c1.285 0 2.324 0 3.146-.108c.854-.111 1.578-.35 2.17-.904c.591-.553.877-1.26 1.046-2.104c.162-.814.23-1.85.316-3.132l.464-6.952a.75.75 0 0 0-1.497-.1l-.46 6.9c-.09 1.347-.154 2.285-.294 2.99c-.137.685-.327 1.047-.6 1.303c-.274.256-.648.422-1.34.512c-.713.093-1.653.095-3.004.095h-.774c-1.35 0-2.29-.002-3.004-.095c-.692-.09-1.066-.256-1.34-.512c-.273-.256-.463-.618-.6-1.303c-.14-.705-.204-1.643-.294-2.99z" />
                    <path fill="#4A6D97"
                      d="M9.425 10.254a.75.75 0 0 1 .821.671l.5 5a.75.75 0 0 1-1.492.15l-.5-5a.75.75 0 0 1 .671-.821m5.821.821a.75.75 0 0 0-1.492-.15l-.5 5a.75.75 0 0 0 1.492.15z" />
                  </svg>
                </button>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
        <div class="mt-3">
          <a type="button" (click)="addOvertimeRow()" class="view-btn add-sec d-flex align-items-center gap-1"
            [style.pointer-events]="allowOvertime ? 'auto' : 'none'"
            [style.cursor]="allowOvertime ? 'pointer' : 'not-allowed'">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
              <g fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10" />
                <path stroke-linecap="round" d="M15 12h-3m0 0H9m3 0V9m0 3v3" />
              </g>
            </svg>
            <span>Add Custom Range</span>
          </a>
        </div>
      </div>
      }
    </div>
  </div>
</div>
}

<!-- Grace Period -->
@if (currentStep === 5) {
<div class="content-hug">
  <div class="content-box d-flex flex-column gap-3">
    <h2>Grace Period</h2>
    <form class="w-lg-50 d-flex flex-column gap-2">
      <div class="form-check d-flex align-items-end justify-content-start p-0 m-0 gap-3">
        <input class="form-check-input m-0" type="checkbox" id="allowGrace" [(ngModel)]="allowGrace"
          [ngModelOptions]="{ standalone: true }" />
        <label class="form-check-label m-0" for="allowGrace">
          Allow Grace Period
        </label>
      </div>
      <div class="input mt-2" [style.opacity]="allowGrace ? '1' : '0.5'">
        <label for="maxCarryover">Allowed Minutes</label>
        <div class="form-outline w-100 position-relative custom-date-wrapper">
          <input type="number" [disabled]="!allowGrace" id="maxCarryover" class="form-control custom-date-input"
            placeholder="Per Day" [(ngModel)]="graceMinutes" [ngModelOptions]="{ standalone: true }" />
        </div>
      </div>
    </form>
  </div>
</div>
}
<div class="btn-fixed d-flex align-items-stretch gap-2">
  @if( currentStep > 1){
  <button type="button" class="btn btn-outline-success bg-white d-flex justify-content-center align-items-center"
    (click)="goPrev()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
        d="M20 12H4m0 0l6-6m-6 6l6 6" />
    </svg>
  </button>
  }

  @if(currentStep < 5){ <button type="button" class="btn btn-lg btn-primary" (click)="goNext()">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
        d="M4 12h16m0 0l-6-6m6 6l-6 6" />
    </svg>
    <span>Next ({{currentStep}}/5)</span>
    </button>
    }

    @if(currentStep === 5){
    <button type="button" class="btn btn-lg btn-success" [disabled]="isSaving || !hasChanges()" (click)="saveChanges()">
      @if (isSaving) {
      <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
      }
      @if (!isSaving) {
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
        <g fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10" />
          <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
        </g>
      </svg>
      }
      <span>
        Save Changes
      </span>
    </button>
    }

</div>


<!-- Discard popup  -->
<app-popup [title]="'Discard Changes'"
  [paragraph1]="'Are you sure you want to discard all changes done to the Absence - Full Time rules?'"
  [paragraph2]="'This action cannot be undone!'" [isOpen]="isModalOpen" (close)="closeModal()">
  <button modal-btn-left class="btn btn-lg btn-dark w-100" (click)="confirmAction()">
    Discard Changes
  </button>
  <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeModal()">
    Keep Editing
  </button>
</app-popup>