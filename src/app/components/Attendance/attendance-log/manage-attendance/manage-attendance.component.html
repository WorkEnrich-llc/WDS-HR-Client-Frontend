<!-- start page header -->
<app-page-header [breadcrumbs]="[
    { label: 'Personal', link: '/attendance-log' },
    { label: 'Attendance Log',link:'/attendance/attendance-log' },
    { label: isEditMode ? 'Edit Attendance Log ' : 'Create New Attendance Log'},
  ]" [title]="isEditMode ? 'Edit Attendance Log ' : 'Create New Attendance Log'" [create]="createDate"
  [update]="updatedDate">

  <button class="btn btn-lg btn-success w-auto" (click)="save()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10" />
        <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
      </g>
    </svg>
    <span>{{isEditMode ? 'Save Changes' : 'Create Attendance Log'}}</span>
  </button>


  <button class="btn btn-lg btn-outline-dark w-auto" (click)="openModal()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10" />
        <path stroke-linecap="round" d="m14.5 9.5l-5 5m0-5l5 5" />
      </g>
    </svg>
    <span>Discard Attendance Log</span>
  </button>
</app-page-header>


<div class="content-hug">
  <div class="content-box d-flex flex-column gap-3">
    <h2>Main Information</h2>
    <form [formGroup]="newLogForm" class="w-lg-50 d-flex flex-column gap-2">
      <div class="input">
        <label for="compCode">Employee<span>*</span></label>
        <div class="form-outline w-100 position-relative custom-date-wrapper employee-dropdown-container">
          @if (employeesLoading) {
            <div class="employee-dropdown-skeleton form-select placeholder-glow">
              <span class="placeholder loademp col-12"></span>
            </div>
          } @else {
            <div class="employee-dropdown">
              <div class="employee-dropdown-header form-select" [class.open]="isEmployeeDropdownOpen"
                [class.disabled]="newLogForm.get('employee_id')?.disabled" (click)="toggleEmployeeDropdown()">
                @if (!selectedEmployee) {
                  <span>Select an employee</span>
                }
                @if (selectedEmployee) {
                  <span>{{selectedEmployee.contact_info?.name}}</span>
                }
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                  style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                  <path fill="currentColor" d="m7 10l5 5l5-5z" />
                </svg>
              </div>
              @if (isEmployeeDropdownOpen) {
                <div class="employee-dropdown-menu">
                  <div class="dropdown-search-wrapper">
                    <input type="text" class="form-control form-control-sm" placeholder="Search employees..."
                      [(ngModel)]="employeeSearchTerm" [ngModelOptions]="{standalone: true}"
                      (input)="filterEmployees()" (click)="$event.stopPropagation()" autocomplete="off" />
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #6c757d;">
                        <path fill="currentColor"
                          d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5l-1.5 1.5l-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16A6.5 6.5 0 0 1 3 9.5A6.5 6.5 0 0 1 9.5 3m0 2C7.01 5 5 7.01 5 9.5S7.01 14 9.5 14S14 11.99 14 9.5S11.99 5 9.5 5" />
                        </svg>
                      </div>
                      <div class="dropdown-items">
                        @if (filteredEmployeeList.length === 0) {
                          <div class="dropdown-item disabled">
                            No employees found
                          </div>
                        } @else {
                          @for (emp of filteredEmployeeList; track emp.id) {
                            <div class="dropdown-item" [class.selected]="selectedEmployee?.id === emp.id"
                              (click)="selectEmployee(emp)">
                              {{emp.contact_info?.name}}
                            </div>
                          }
                        }
                      </div>
                    </div>
                  }
                  <input type="hidden" formControlName="employee_id" />
                </div>
              }
            </div>
            @if (newLogForm.get('employee_id')?.touched && newLogForm.get('employee_id')?.errors?.['required']) {
              <p class="error-msg">
                Employee is required.
              </p>
            }
          </div>

          <div class="input">
            <label for="date">Select a date<span>*</span></label>
            <div class="form-outline w-100 position-relative custom-date-wrapper">
              <input type="text" id="date" class="form-control custom-date-input" placeholder="Select a Day or More"
                formControlName="date" appDateInput [max]="maxDate" />
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                  <g fill="none" stroke-width="1.5">
                    <path stroke-linecap="round"
                      d="M22 14v-2c0-3.771 0-5.657-1.172-6.828S17.771 4 14 4h-4C6.229 4 4.343 4 3.172 5.172S2 8.229 2 12v2c0 3.771 0 5.657 1.172 6.828S6.229 22 10 22h4M7 4V2.5M17 4V2.5" />
                      <circle cx="18" cy="18" r="3" />
                      <path stroke-linecap="round" d="M20.5 20.5L22 22M2.5 9h19" />
                    </g>
                  </svg>
                </div>
                @if (newLogForm.get('date')?.touched && newLogForm.get('date')?.errors?.['required']) {
                  <p class="error-msg">
                    Date is required.
                  </p>
                }
                @if (newLogForm.get('date')?.touched && newLogForm.get('date')?.errors?.['futureDate']) {
                  <p class="error-msg">
                    Cannot select a future date. Attendance logs can only be created for today or past dates.
                  </p>
                }
              </div>

              <div class="input gap-3">
                <label for="start">Logged hours<span>*</span></label>
                <div class="d-flex gap-3">
                  <div class="input w-50">
                    <div class="form-outline w-100 position-relative custom-date-wrapper">
                      <input type="text" id="start" class="form-control custom-date-input" placeholder="Start"
                        formControlName="start" appTimeDisplay />
                      </div>
                      @if (newLogForm.get('start')?.touched && newLogForm.get('start')?.errors?.['required']) {
                        <p class="error-msg">
                          Start time is required.
                        </p>
                      }
                    </div>
                    <div class="input w-50">
                      <div class="form-outline w-100 position-relative custom-date-wrapper">
                        <input type="text" id="end" class="form-control custom-date-input" placeholder="End"
                          formControlName="end" appTimeDisplay />
                        </div>
                        @if (newLogForm.get('end')?.touched && newLogForm.get('end')?.errors?.['required']) {
                          <p class="error-msg">
                            End time is required.
                          </p>
                        }
                      </div>
                    </div>
                  </div>

                </form>
              </div>
            </div>



            <!-- Discard popup  -->
            <app-popup [title]="'Discard Changes'"
              [paragraph1]="'Are you sure you want to discard creating the new attendance log?'"
              [paragraph2]="'This action cannot be undone!'" [isOpen]="isModalOpen" (close)="closeModal()">
              <button modal-btn-left class="btn btn-lg btn-dark w-100" (click)="confirmAction()">
                Discard Changes
              </button>
              <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeModal()">
                Cancel
              </button>
            </app-popup>