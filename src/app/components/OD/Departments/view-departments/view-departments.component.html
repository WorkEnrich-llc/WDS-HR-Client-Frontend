<app-page-header [breadcrumbs]="[
    { label: 'Operations Development', link: '/departments' },
    { label: 'Departments', link: '/departments' },
    {  label: 'View Department ' + departmentData?.name }
  ]" [title]="'View Department - ' + departmentData?.name" [create]="formattedCreatedAt" [update]="formattedUpdatedAt"
  [isLoading]="loadData">

  @if (!loadData) {
  @if(departmentsSub?.update){
  <button class="btn btn-lg btn-primary" [routerLink]="['/departments/edit', departmentData?.id]">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round"
          d="M22 10.5V12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12s0-7.071 1.464-8.536C4.93 2 7.286 2 12 2h1.5" />
        <path
          d="m16.652 3.455l.649-.649A2.753 2.753 0 0 1 21.194 6.7l-.65.649m-3.892-3.893s.081 1.379 1.298 2.595c1.216 1.217 2.595 1.298 2.595 1.298m-3.893-3.893L10.687 9.42c-.404.404-.606.606-.78.829q-.308.395-.524.848c-.121.255-.211.526-.392 1.068L8.412 13.9m12.133-6.552l-5.965 5.965c-.404.404-.606.606-.829.78a4.6 4.6 0 0 1-.848.524c-.255.121-.526.211-1.068.392l-1.735.579m0 0l-1.123.374a.742.742 0 0 1-.939-.94l.374-1.122m1.688 1.688L8.412 13.9" />
      </g>
    </svg>
    <span>Edit</span>
  </button>
  }


  @if (!departmentData.is_active) {
  <button class="btn btn-lg btn-outline-success" (click)="openActivate()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Activate</span>
  </button>
  }

  @if (departmentData.is_active) {
  <button class="btn btn-lg btn-outline-danger" (click)="openDeactivate()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Deactivate</span>
  </button>
  }
  }

</app-page-header>


<div class="content-hug d-flex flex-column gap-4">
  <div class="content-box d-flex flex-column gap-3">
    <h2>Main Information</h2>
    @if(loadData) {
    <app-skelaton-loading class="w-50" [rows]="3" [hasLabel]="true" [labelHeight]="16" [valueHeight]="20">
    </app-skelaton-loading>

    }@else {
    <div class="info">
      <h6>Department Code</h6>
      <span>{{ departmentData?.id?.toString()?.padStart(4, '0') || 'N/A' }}</span>
    </div>
    <div class="info">
      <h6>Department Name</h6>
      <p class="fs-6 lh-base">{{ departmentData?.name || 'N/A' }}</p>
    </div>
    <div class="info">
      <h6>Department Objectives</h6>
      @if (departmentData?.objectives) {
      <!-- <ul>
        @for (item of departmentData.objectives.split('\n'); track $index) {
        <li class="fs-6 lh-base">{{ item }}</li>
        }

      </ul> -->
      @for (item of departmentData.objectives.split('\n'); track $index) {
      <p class="m-0 fs-6 lh-base">{{ item }}</p>
      }

      }
    </div>
    }


  </div>

  <div class="content-box pt-0">
    <ul class="nav d-flex align-items-center nav-tabs bg-white p-0 px-3 mb-3">


      <li class="nav-item" [class.active]="activeTab === 'sections'" (click)="setActiveTab('sections')">

        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
          <path fill-rule="evenodd"
            d="M17.5 2.75a.75.75 0 0 1 .75.75v2.25h2.25a.75.75 0 0 1 0 1.5h-2.25V9.5a.75.75 0 0 1-1.5 0V7.25H14.5a.75.75 0 0 1 0-1.5h2.25V3.5a.75.75 0 0 1 .75-.75"
            clip-rule="evenodd" />
          <path
            d="M2 6.5c0-2.121 0-3.182.659-3.841S4.379 2 6.5 2s3.182 0 3.841.659S11 4.379 11 6.5s0 3.182-.659 3.841S8.621 11 6.5 11s-3.182 0-3.841-.659S2 8.621 2 6.5m11 11c0-2.121 0-3.182.659-3.841S15.379 13 17.5 13s3.182 0 3.841.659S22 15.379 22 17.5s0 3.182-.659 3.841S19.621 22 17.5 22s-3.182 0-3.841-.659S13 19.621 13 17.5" />
          <path
            d="M2 17.5c0-2.121 0-3.182.659-3.841S4.379 13 6.5 13s3.182 0 3.841.659S11 15.379 11 17.5s0 3.182-.659 3.841S8.621 22 6.5 22s-3.182 0-3.841-.659S2 19.621 2 17.5"
            opacity=".5" />
        </svg>
        <span class="nav-link">Sections</span>

      </li>

      <li class="nav-item" [class.active]="activeTab === 'goals'" (click)="setActiveTab('goals')">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
          <path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity=".5" />
          <path
            d="M9.25 12a.75.75 0 0 1 .75-.75h1.25V10a.75.75 0 0 1 1.5 0v1.25H14a.75.75 0 0 1 0 1.5h-1.25V14a.75.75 0 0 1-1.5 0v-1.25H10a.75.75 0 0 1-.75-.75m-7.222.75a10 10 0 0 1 0-1.5H5a.75.75 0 0 1 0 1.5zm10.722 9.222a10 10 0 0 1-1.5 0V19a.75.75 0 0 1 1.5 0zm9.222-10.722a10 10 0 0 1 0 1.5H19a.75.75 0 0 1 0-1.5zM12.75 2.028V5a.75.75 0 0 1-1.5 0V2.028a10 10 0 0 1 1.5 0" />
        </svg>
        <span class="nav-link cursor-pointer">Goals</span>

      </li>

    </ul>



    @if (activeTab === 'sections') {
    <h2 class="mb-3">Sections</h2>

    <app-table [isLoading]="loadData" [columnsCount]="3" [data]="departmentData.sections" [totalItems]="totalItems"
      [itemsPerPage]="itemsPerPage" [currentPage]="currentPage" (pageChange)="onPageChange($event)"
      (itemsPerPageChange)="onItemsPerPageChange($event)" [headerTemplate]="sectionsTableHeader"
      [rowTemplate]="sectionsTableRow" [emptyTemplate]="noSections"></app-table>

    <ng-template #sectionsTableHeader>
      <th (click)="sortBy('id')" style="cursor: pointer;" class="w-25">
        <div class="d-flex align-items-center justify-content-between">
          <span>Section</span>
          @if (sortDirection === 'desc') {
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g fill="none" stroke="#DDE3EB" stroke-linecap="round" stroke-width="1.5">
              <path d="M4 8h9m-7 5h7m-5 5h5" />
              <path stroke-linejoin="round" d="M17 20V4l3 4" />
            </g>
          </svg>
          }
          @if (sortDirection === 'asc') {
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <path fill="#DDE3EB" fill-rule="evenodd"
              d="M17 3.25a.75.75 0 0 1 .75.75v13.75l1.65-2.2a.75.75 0 1 1 1.2.9l-3 4a.75.75 0 0 1-1.35-.45V4a.75.75 0 0 1 .75-.75M7.25 6A.75.75 0 0 1 8 5.25h5a.75.75 0 0 1 0 1.5H8A.75.75 0 0 1 7.25 6m-2 5a.75.75 0 0 1 .75-.75h7a.75.75 0 0 1 0 1.5H6a.75.75 0 0 1-.75-.75m-2 5a.75.75 0 0 1 .75-.75h9a.75.75 0 0 1 0 1.5H4a.75.75 0 0 1-.75-.75"
              clip-rule="evenodd" />
          </svg>
          }
        </div>
      </th>
      <th class="width-fix">Subsections</th>

      <th>Status</th>

    </ng-template>

    <ng-template #sectionsTableRow let-section let-i="index">
      <td>
        <span class="d-block text-gray-sm">{{ section.id.toString().padStart(4, '0') }}</span>
        <span class="d-block text-truncate" style="max-width: 200px;">
          {{ section.name }}
        </span>
      </td>
      <td>
        @if (section.sub_sections?.length > 0) {
        @for (sub of section.sub_sections; track sub.id) {
        <span class="inline-flex items-center gap-1">
          @if (sub.is_active) {
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10">
            <circle cx="5" cy="5" r="5" fill="#4ca883" />
          </svg>
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 10 10">
            <circle cx="5" cy="5" r="5" fill="#e04f5f" />
          </svg>
          }
          <span class="ms-1 text-gray-sm">{{ sub.name }}</span>
        </span>
        @if (section.sub_sections.indexOf(sub) !== section.sub_sections.length - 1) {
        <span class="ms-1 me-2">, </span>
        }
        }
        } @else {
        <span class="text-gray-400 italic">No subsections</span>
        }
      </td>


      <td>
        @if (section.is_active ===true) {
        <span class="badge-success">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
            <g fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10" />
              <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
            </g>
          </svg>
          <span>Active</span>
        </span>
        }
        @if (section.is_active ===false) {
        <span class="badge-danger">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
            <g fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10" />
              <path stroke-linecap="round" d="m14.5 9.5l-5 5m0-5l5 5" />
            </g>
          </svg>
          <span>Not Active</span>
        </span>
        }
      </td>
    </ng-template>

    <ng-template #noSections>
      <tr>
        <td colspan="3" class="no-data py-4">
          No Sections Added Yet.
        </td>
      </tr>
    </ng-template>



    }


    @if (activeTab === 'goals') {
    <h2 class="mb-3">Assigned Goals</h2>

    <app-table [isLoading]="loadData" [columnsCount]="1" [data]="departmentData.assigned_goals"
      [totalItems]="totalItemsGoals" [itemsPerPage]="itemsPerPage" [currentPage]="currentPage"
      (pageChange)="onPageChange($event)" (itemsPerPageChange)="onItemsPerPageChange($event)"
      [headerTemplate]="goalsTableHeader" [rowTemplate]="goalsTableRow" [emptyTemplate]="noGoals"></app-table>

    <ng-template #goalsTableHeader>
      <th style="cursor: pointer;">
        <div class="d-flex align-items-center justify-content-between">
          <span>Goals</span>
        </div>
      </th>

    </ng-template>

    <ng-template #goalsTableRow let-goal let-i="index">
      <td>
        <span class="d-block text-gray-sm">{{ goal.id.toString().padStart(4, '0') }}</span>
        <span class="d-block text-truncate" style="max-width: 200px;">
          {{ goal.name }}
        </span>
      </td>
    </ng-template>

    <ng-template #noGoals>
      <tr>
        <td colspan="3" class="no-data py-4">
          No Goals Added Yet.
        </td>
      </tr>
    </ng-template>
    }

  </div>

  <!-- Department Checklist Component with Badge -->
  @if (departmentChecklistItems && departmentChecklistItems.length > 0) {
  <app-onboarding-checklist [isOpen]="isChecklistModalOpen" [checklistItems]="departmentChecklistItems"
    [showBadge]="true" [completed]="checklistCompleted" [total]="checklistTotal" [allowToggle]="false" [readOnly]="true"
    [disabledItemTitles]="disabledChecklistTitles" [loadingItemTitle]="loadingChecklistItemTitle"
    (close)="closeChecklistModal()" (badgeClick)="openChecklistModal()">
  </app-onboarding-checklist>
  }

</div>

<!-- deactivate popup  -->
<app-popup [title]="'Deactivate Department'"
  [paragraph1]="'Are you sure you want to deactivate the Department “' + departmentData?.name + '”?'"
  [paragraph2]="'This will only hold any access this title has to the system. You can activate it at any time later.'"
  [isOpen]="deactivateOpen" (close)="closeDeactivate()">
  <button modal-btn-left class="btn btn-lg btn-danger w-100" (click)="confirmDeactivate()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Deactivate</span>
  </button>
  <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeDeactivate()">
    Cancel
  </button>
</app-popup>

<!-- activate popup  -->
<app-popup [title]="'Activate Department'"
  [paragraph1]="'Are you sure you want to Activate the Department “' + departmentData?.name + '”?'"
  [paragraph2]="'You can deactivate it at any time later.'" [isOpen]="activateOpen" (close)="closeActivate()">
  <button modal-btn-left class="btn btn-lg btn-success w-100" (click)="confirmActivate()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Activate</span>
  </button>
  <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeActivate()">
    Cancel
  </button>
</app-popup>