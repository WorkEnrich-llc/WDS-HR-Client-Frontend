<!-- Page header and breadcrumb will be added here -->
<app-page-header [breadcrumbs]="breadcrumbs" title="Bonus/Deduction Details">
    @if (!isLoading) {
    <div class="d-flex gap-2">
        <button class="btn btn-lg btn-primary"
            [routerLink]="['/bonus-deductions/edit-bonus-deduction', bonusDeduction.id]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round"
                        d="M22 10.5V12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12s0-7.071 1.464-8.536C4.93 2 7.286 2 12 2h1.5" />
                    <path
                        d="m16.652 3.455l.649-.649A2.753 2.753 0 0 1 21.194 6.7l-.65.649m-3.892-3.893s.081 1.379 1.298 2.595c1.216 1.217 2.595 1.298 2.595 1.298m-3.893-3.893L10.687 9.42c-.404.404-.606.606-.78.829q-.308.395-.524.848c-.121.255-.211.526-.392 1.068L8.412 13.9m12.133-6.552l-5.965 5.965c-.404.404-.606.606-.829.78a4.6 4.6 0 0 1-.848.524c-.255.121-.526.211-1.068.392l-1.735.579m0 0l-1.123.374a.742.742 0 0 1-.939-.94l.374-1.122m1.688 1.688L8.412 13.9" />
                </g>
            </svg>
            <span>Edit</span>
        </button>
        <button class="btn btn-lg btn-outline-danger" (click)="openRemove()">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
                    d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
            </svg>
            <span>Remove</span>
        </button>
    </div>
    }

    <!-- Remove confirmation popup -->
    <app-popup [title]="'Remove Bonus/Deduction'" [paragraph1]="'Are you sure you want to remove this Bonus/Deduction?'"
        [paragraph2]="'This action cannot be undone.'" [isOpen]="removeOpen" (close)="closeRemove()">
        <button modal-btn-left class="btn btn-lg btn-danger w-100" (click)="confirmRemove()">
            <span>Remove</span>
        </button>
        <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeRemove()">
            Cancel
        </button>
    </app-popup>
</app-page-header>
<div class="content-hug">
    @if (isLoading) {
    <div class="content-box">
        <h5 class="mb-4 fw-semibold card-section-header">Main Info</h5>
        <div class="skeleton-loader skeleton-main-info mb-4"></div>
    </div>
    <div class="content-box mt-3">
        <h5 class="mb-4 fw-semibold card-section-header">Recipients</h5>
        <div class="skeleton-loader skeleton-recipients-table"></div>
    </div>
    }
    @else if (bonusDeduction) {
    <div class="content-box">
        <h5 class="mb-4 fw-semibold card-section-header">Main Info</h5>
        <div class="d-flex flex-column gap-2">
            <div class="field-item">
                <label class="field-label text-muted small">Date</label>
                <div class="field-value">{{ bonusDeduction.date | date: 'dd MMMM yyyy' }}</div>
            </div>
            <div class="field-item">
                <label class="field-label text-muted small">Cycle</label>
                <div class="field-value">25 March â€“ 24 April</div>
                <!-- Placeholder, replace with real cycle if available -->
            </div>
            <div class="field-item">
                <label class="field-label text-muted small">Number of Employees</label>
                <div class="field-value">84</div> <!-- Placeholder, replace with real count if available -->
            </div>
            <div class="field-item">
                <label class="field-label text-muted small">Classification</label>
                <div class="field-value">{{ bonusDeduction.classification?.name }}</div>
            </div>
            <div class="field-item">
                <label class="field-label text-muted small">Amount</label>
                <div class="field-value">{{ bonusDeduction.days ? (bonusDeduction.days + ' Days') :
                    (bonusDeduction.amount ? (bonusDeduction.amount + ' EGP') : '') }}</div>
            </div>
            <div class="field-item">
                <label class="field-label text-muted small">Salary Portion</label>
                <div class="field-value">{{ bonusDeduction.salary_portion?.name || '-' }}</div>
            </div>
            <div class="field-item">
                <label class="field-label text-muted small">Status</label>
                <div class="field-value">
                    @if (bonusDeduction.status?.name === 'Applied') {
                    <span class="badge-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                            <g fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
                            </g>
                        </svg>
                        <span>Applied</span>
                    </span>
                    } @else if (bonusDeduction.status?.name === 'Pending') {
                    <span class="badge-newjoiner">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                            <g fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10" />
                                <path stroke-linecap="round" d="M12 7v5l3 3" />
                            </g>
                        </svg>
                        <span>Pending</span>
                    </span>
                    } @else {
                    <span class="badge-gray bg-gray-subtle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                            <g fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10" />
                            </g>
                        </svg>
                        <span>{{ bonusDeduction.status?.name || 'Unknown' }}</span>
                    </span>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="content-box mt-3">
        <h5 class="mb-4 fw-semibold card-section-header">Recipients</h5>
        <div class="mb-3 position-relative" style="max-width:400px;">
            <input class="form-control rounded-3 px-4 py-2" style="border:1px solid #bfcad6;" placeholder="Search"
                [(ngModel)]="recipientSearch" />
            <span style="position:absolute;right:16px;top:50%;transform:translateY(-50%);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                    <g fill="none" stroke="#377AFD" stroke-width="1.5">
                        <circle cx="11.5" cy="11.5" r="9.5" />
                        <path stroke-linecap="round" d="M18.5 18.5L22 22" />
                    </g>
                </svg>
            </span>
        </div>
        <app-table [data]="filteredRecipients" [isLoading]="isLoadingRecipients" [columnsCount]="2"
            [totalItems]="totalRecipients" [itemsPerPage]="recipientsPerPage" [currentPage]="recipientsPage"
            (pageChange)="onRecipientsPageChange($event)" (itemsPerPageChange)="onRecipientsPerPageChange($event)"
            [headerTemplate]="recipientsTableHeader" [rowTemplate]="recipientsTableRow" [emptyTemplate]="noRecipients">
        </app-table>

        <ng-template #recipientsTableHeader>
            <th>Employee</th>
            <th class="text-end">Actions</th>
        </ng-template>

        <ng-template #recipientsTableRow let-emp>
            <td>
                <div class="text-muted small">{{ emp.id }}</div>
                <div>{{ emp.name }}</div>
            </td>
            <td class="text-end">
                <a class="edit-btn" title="View" [routerLink]="['/employees/view-employee', emp.id]">
                    <svg width="18" height="18" viewBox="0 0 24 24">
                        <g fill="none" stroke="#377AFD" stroke-width="1.5">
                            <path
                                d="M3.275 15.296C2.425 14.192 2 13.639 2 12c0-1.64.425-2.191 1.275-3.296C4.972 6.5 7.818 4 12 4s7.028 2.5 8.725 4.704C21.575 9.81 22 10.361 22 12c0 1.64-.425 2.191-1.275 3.296C19.028 17.5 16.182 20 12 20s-7.028-2.5-8.725-4.704Z" />
                            <path d="M15 12a3 3 0 1 1-6 0a3 3 0 0 1 6 0Z" />
                        </g>
                    </svg>
                </a>
            </td>
        </ng-template>

        <ng-template #noRecipients>
            <tr>
                <td colspan="2" class="text-center">No recipients found.</td>
            </tr>
        </ng-template>
    </div>
    }
    @else {
    <span>Loading...</span>
    }
</div>