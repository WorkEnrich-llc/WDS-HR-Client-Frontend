<!-- start page header -->
<app-page-header 
  [breadcrumbs]="[
    { label: 'Personnel', link: '/dashboard' },
    { label: 'Delegation', link: '/delegation' },
     { label: 'Edit Delegation' }
  ]" 
  [title]="isEditMode ? 'Edit Delegation' : 'Create New Delegation'">
  
  <button class="btn btn-lg btn-success w-auto" 
    (click)="onSubmit()" 
    [disabled]="delegationForm.invalid || isSubmitting">
    @if (isSubmitting) {
      <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
    }
    @if (!isSubmitting) {
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
        <g fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10" />
          <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
        </g>
      </svg>
    }
    <span>{{ isEditMode ? 'Save Changes' : 'Create Delegation' }}</span>
  </button>

  <button class="btn btn-lg btn-outline-dark w-auto" (click)="openModal()">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="12" cy="12" r="10" />
        <path stroke-linecap="round" d="m14.5 9.5l-5 5m0-5l5 5" />
      </g>
    </svg>
    <span>Discard Changes</span>
  </button>
</app-page-header>
<!-- end page header -->

<!-- Loading State -->
<div *ngIf="isLoading" class="content-hug">
  <div class="content-box d-flex justify-content-center align-items-center" style="min-height: 400px;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<!-- Main Content -->
<div *ngIf="!isLoading" class="content-hug">
  <div class="content-box d-flex flex-column gap-3">
    <h2>Main Information</h2>
    <div [formGroup]="delegationForm" class="w-lg-50 d-flex flex-column gap-2">
      <!-- Start Date -->
      <div class="input">
        <label for="startDate">Start Date <span>*</span></label>
        <div class="form-outline w-100 position-relative custom-date-wrapper">
          <input 
            type="date" 
            id="startDate" 
            class="form-control custom-date-input"
            formControlName="from_date"
            [class.is-invalid]="isFieldInvalid('from_date')"
            [min]="currentDate" />
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g fill="none" stroke-width="1.5">
              <path stroke-linecap="round"
                d="M22 14v-2c0-3.771 0-5.657-1.172-6.828S17.771 4 14 4h-4C6.229 4 4.343 4 3.172 5.172S2 8.229 2 12v2c0 3.771 0 5.657 1.172 6.828S6.229 22 10 22h4M7 4V2.5M17 4V2.5" />
              <circle cx="18" cy="18" r="3" />
              <path stroke-linecap="round" d="M20.5 20.5L22 22M2.5 9h19" />
            </g>
          </svg>
        </div>
        @if (isFieldInvalid('from_date')) {
          <p class="error-msg">
            {{ getFieldError('from_date') }}
          </p>
        }
      </div>

      <!-- End Date -->
      <div class="input">
        <label for="endDate">End Date <span>*</span></label>
        <div class="form-outline w-100 position-relative custom-date-wrapper">
          <input 
            type="date" 
            id="endDate" 
            class="form-control custom-date-input"
            formControlName="to_date"
            [class.is-invalid]="isFieldInvalid('to_date') || delegationForm.errors?.['dateRange']"
            [min]="currentDate" />
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
            <g fill="none" stroke-width="1.5">
              <path stroke-linecap="round"
                d="M22 14v-2c0-3.771 0-5.657-1.172-6.828S17.771 4 14 4h-4C6.229 4 4.343 4 3.172 5.172S2 8.229 2 12v2c0 3.771 0 5.657 1.172 6.828S6.229 22 10 22h4M7 4V2.5M17 4V2.5" />
              <circle cx="18" cy="18" r="3" />
              <path stroke-linecap="round" d="M20.5 20.5L22 22M2.5 9h19" />
            </g>
          </svg>
        </div>
        @if (isFieldInvalid('to_date') || delegationForm.errors?.['dateRange']) {
          <p class="error-msg">
            {{ getFieldError('to_date') }}
          </p>
        }
      </div>

      <!-- Delegator -->
      <div class="input">
        <label for="delegator">Delegator <span>*</span></label>
        <div class="form-outline w-100 position-relative">
          <select 
            id="delegator" 
            class="form-select"
            formControlName="delegator_id"
            [class.is-invalid]="isFieldInvalid('delegator_id')">
            <option value="" disabled selected hidden>Select Delegator</option>
            <option *ngFor="let employee of employees" [value]="employee.id">
              {{ employee.name }}
            </option>
          </select>
        </div>
        @if (isFieldInvalid('delegator_id')) {
          <p class="error-msg">
            {{ getFieldError('delegator_id') }}
          </p>
        }
      </div>

      <!-- Delegate -->
      <div class="input">
        <label for="delegate">Delegate <span>*</span></label>
        <div class="form-outline w-100 position-relative">
          <select 
            id="delegate" 
            class="form-select"
            formControlName="delegate_id"
            [class.is-invalid]="isFieldInvalid('delegate_id')">
            <option value="" disabled selected hidden>Select Delegate</option>
            <option *ngFor="let employee of employees" [value]="employee.id">
              {{ employee.name }}
            </option>
          </select>
        </div>
        @if (isFieldInvalid('delegate_id')) {
          <p class="error-msg">
            {{ getFieldError('delegate_id') }}
          </p>
        }
      </div>
    </div>
  </div>
</div>

<!-- Discard Changes Modal -->
@if (isModalOpen) {
  <app-popup
    [title]="'Discard Changes'"
    [paragraph1]="'Are you sure you want to discard changes?'"
    [paragraph2]="'This action cannot be undone!'"
    [isOpen]="isModalOpen"
    (close)="closeModal()">
    <button modal-btn-left class="btn btn-lg btn-dark w-100" (click)="confirmAction()">
      Discard Changes
    </button>
    <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeModal()">
      Cancel
    </button>
  </app-popup>
}

<!-- Success Modal -->
@if (isSuccessModalOpen) {
  <app-popup 
    [title]="isEditMode ? 'Delegation Updated' : 'Delegation Created'"
    [paragraph1]="isEditMode ? 'The delegation has been updated successfully.' : 'The new delegation has been created successfully.'"
    [isOpen]="isSuccessModalOpen"
    (close)="closeSuccessModal()">
    
    <button modal-btn-left class="btn btn-lg btn-outline-primary w-100" (click)="viewDelegations()">
      View Delegations
    </button>
    <button modal-btn-right class="btn btn-lg btn-primary w-100" (click)="isEditMode ? viewDelegations() : createAnother()">
      {{ isEditMode ? 'Done' : 'Create Another' }}
    </button>
  </app-popup>
}
