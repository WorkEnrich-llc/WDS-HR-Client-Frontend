<div class="dashboard-tab-content">
  @if (isLoading) {
  <div class="d-flex justify-content-center align-items-center w-100" style="min-height: 400px">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem" role="status"></div>
  </div>
  } @else {
  <div class="dashboard-grid">
    <!-- Attendance Card (Full Width) -->
    <div class="chart-card attendance-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <div class="header-title">
          <h2>Attendance</h2>
          <p class="text-muted small mb-0">Monthly attendance percentage tracking</p>
        </div>
        <div class="form-outline select-inner">
          <select class="form-select" (change)="onParamChangeEvent('attendance_year', $event)">
            @for (y of years; track $index) {
            <option [value]="y.value">{{ y.label }}</option>
            }
          </select>
        </div>
      </div>
      <div class="chart-container" style="height: 320px; width: 100%;">
        <canvas baseChart [data]="attendanceData" [type]="'bar'" [options]="attendanceOptions"></canvas>
      </div>
    </div>

    <!-- Requests Card -->
    <div class="chart-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <h2>Requests</h2>
        <div class="form-outline select-inner">
          <select class="form-select" (change)="onParamChangeEvent('request_month', $event)">
            @for (m of months; track $index) {
            <option [value]="m.value">{{ m.label }}</option>
            }
          </select>
        </div>
      </div>
      <div class="d-flex flex-column align-items-center flex-xl-row gap-3">
        <div class="chart-wrapper position-relative" style="width: 160px; height: 160px;">
          <canvas baseChart [data]="requestsData" [type]="'doughnut'" [options]="requestsOptions"></canvas>
        </div>
        <div class="chart-legend w-100">
          <div class="legend-list d-flex flex-column gap-1">
            @for (item of getSectionValues('Requests'); track $index) {
            <div class="sticker">
              <div class="label-color" [style.background-color]="item.color_code"></div>
              <p class="flex-grow-1">{{ item.label }}</p>
              <div class="number text-end">{{ item.value }}</div>
            </div>
            }
            <div class="legend-divider"></div>
            <div class="sticker total">
              <div class="label-color" style="background-color: transparent"></div>
              <p class="flex-grow-1">Total</p>
              <div class="number text-end">{{ getSectionTotal('Requests') }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leave Balance Card -->
    <div class="chart-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <h2>Leave Balance</h2>
        <div class="form-outline select-inner" style="max-width: 140px;">
          <select class="form-select" (change)="onParamChangeEvent('leave_balance_leave_id', $event)">
            <option value="">All Types</option>
            @for (lt of leaveTypes; track $index) {
            <option [value]="lt.leave.id">{{ lt.leave.name }}</option>
            }
          </select>
        </div>
      </div>
      <div class="d-flex flex-column align-items-center flex-xl-row gap-3">
        <div class="chart-wrapper position-relative" style="width: 160px; height: 160px;">
          <canvas baseChart [data]="leaveBalanceData" [type]="'doughnut'" [options]="leaveBalanceOptions"></canvas>
        </div>
        <div class="chart-legend w-100">
          <div class="legend-list d-flex flex-column gap-1">
            @for (item of getSectionValues('Leave Balance'); track $index) {
            <div class="sticker">
              <div class="label-color" [style.background-color]="item.color_code"></div>
              <p class="flex-grow-1">{{ item.label }}</p>
              <div class="number text-end">{{ item.value }}</div>
            </div>
            }
            <div class="legend-divider"></div>
            <div class="sticker total">
              <div class="label-color" style="background-color: transparent"></div>
              <p class="flex-grow-1">Total</p>
              <div class="number text-end">{{ getSectionTotal('Leave Balance') }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Organizational Chart Card -->
    <div class="chart-card org-chart-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <h2>Structure</h2>
      </div>

      @if (getEmployeeHierarchy().length > 0) {
      <div class="org-chart-wrapper">
        <div class="employee-hierarchy-list">
          @for (emp of getEmployeeHierarchy(); track emp.id) {
          <div class="employee-card mb-1" [class.employee-card--manager]="emp.type === 'manager'"
            [class.employee-card--current]="emp.type === 'current'"
            [class.employee-card--subordinate]="emp.type === 'employee'">
            @if (emp.type === 'manager' || emp.type === 'employee' || emp.type === 'current') {
            <div class="hierarchy-arrow" [style.margin-left.px]="emp.level * 20">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                <path d="M4 4 Q 4 16, 16 16 L 28 16" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M24 12 L 28 16 L 24 20" stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
            }
            <div class="employee-avatar" style="width: 40px; height: 40px;">
              <img [src]="emp.picture || defaultImage" [alt]="emp.name"
                onerror="this.src='./images/profile-defult.jpg'">
            </div>
            <div class="employee-info">
              <div class="employee-name" style="font-size: 14px;">{{ emp.name }}</div>
              <div class="employee-id">{{ emp.job_title }}</div>
            </div>
          </div>
          }
        </div>

        <!-- View Full Chart Button -->
        <div class="view-full-chart">
          <button class="btn-view-chart" (click)="navigateToOrgChart()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
              <path fill="currentColor"
                d="M14 3v2h3.59l-9.83 9.83l1.41 1.41L19 6.41V10h2V3m-2 16H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2z" />
            </svg>
            View Full Chart
          </button>
        </div>
      </div>
      } @else {
      <div class="empty-state py-4">
        <p class="small text-muted mb-0">No organizational data available</p>
      </div>
      }
    </div>
  </div>
  }