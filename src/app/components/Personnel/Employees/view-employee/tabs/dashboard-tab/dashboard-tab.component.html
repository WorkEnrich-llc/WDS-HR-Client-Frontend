<div class="dashboard-tab-content">
  @if (isLoading) {
  <div class="d-flex justify-content-center align-items-center w-100" style="min-height: 400px">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem" role="status"></div>
  </div>
  } @else {
  <div class="dashboard-grid">
    <!-- Attendance Card (Full Width) -->
    <div class="chart-card attendance-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <div class="header-title">
          <h2>Attendance</h2>
          <p class="text-muted small mb-0">Monthly attendance percentage tracking</p>
        </div>
        <div class="form-outline select-inner">
          <select class="form-select" (change)="onParamChangeEvent('attendance_year', $event)">
            @for (y of years; track $index) {
            <option [value]="y.value">{{ y.label }}</option>
            }
          </select>
        </div>
      </div>
      <div class="chart-container" style="height: 320px; width: 100%;">
        <canvas baseChart [data]="attendanceData" [type]="'bar'" [options]="attendanceOptions"></canvas>
      </div>
    </div>

    <!-- Requests Card -->
    <div class="chart-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <h2>Requests</h2>
        <div class="form-outline select-inner">
          <select class="form-select" (change)="onParamChangeEvent('request_month', $event)">
            @for (m of months; track $index) {
            <option [value]="m.value">{{ m.label }}</option>
            }
          </select>
        </div>
      </div>
      <div class="d-flex flex-column align-items-center flex-xl-row gap-3">
        <div class="chart-wrapper position-relative" style="width: 160px; height: 160px;">
          <canvas baseChart [data]="requestsData" [type]="'doughnut'" [options]="requestsOptions"></canvas>
        </div>
        <div class="chart-legend w-100">
          <div class="legend-list d-flex flex-column gap-1">
            @for (item of getSectionValues('Requests'); track $index) {
            <div class="sticker">
              <div class="label-color" [style.background-color]="item.color_code"></div>
              <p class="flex-grow-1">{{ item.label }}</p>
              <div class="number text-end">{{ item.value }}</div>
            </div>
            }
            <div class="legend-divider"></div>
            <div class="sticker total">
              <div class="label-color" style="background-color: transparent"></div>
              <p class="flex-grow-1">Total</p>
              <div class="number text-end">{{ getSectionTotal('Requests') }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leave Balance Card -->
    <div class="chart-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <h2>Leave Balance</h2>
        <div class="form-outline select-inner" style="max-width: 140px;">
          <select class="form-select" (change)="onParamChangeEvent('leave_balance_leave_id', $event)">
            <option value="">All Types</option>
            @for (lt of leaveTypes; track $index) {
            <option [value]="lt.leave.id">{{ lt.leave.name }}</option>
            }
          </select>
        </div>
      </div>
      <div class="d-flex flex-column align-items-center flex-xl-row gap-3">
        <div class="chart-wrapper position-relative" style="width: 160px; height: 160px;">
          <canvas baseChart [data]="leaveBalanceData" [type]="'doughnut'" [options]="leaveBalanceOptions"></canvas>
        </div>
        <div class="chart-legend w-100">
          <div class="legend-list d-flex flex-column gap-1">
            @for (item of getSectionValues('Leave Balance'); track $index) {
            <div class="sticker">
              <div class="label-color" [style.background-color]="item.color_code"></div>
              <p class="flex-grow-1">{{ item.label }}</p>
              <div class="number text-end">{{ item.value }}</div>
            </div>
            }
            <div class="legend-divider"></div>
            <div class="sticker total">
              <div class="label-color" style="background-color: transparent"></div>
              <p class="flex-grow-1">Total</p>
              <div class="number text-end">{{ getSectionTotal('Leave Balance') }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Organizational Chart Card -->
    <div class="chart-card org-chart-card">
      <div class="card-header d-flex align-items-center justify-content-between mb-4">
        <h2>Structure</h2>
      </div>

      @if (isLoadingOrgChart) {
      <div class="org-chart-wrapper">
        <div class="employee-hierarchy-list">
          @for (i of [1,2,3,4]; track $index) {
          <div class="employee-card skeleton mb-2">
            <div class="hierarchy-arrow skeleton-arrow"></div>
            <div class="employee-avatar skeleton-avatar"></div>
            <div class="employee-info">
              <div class="skeleton-line skeleton-id"></div>
              <div class="skeleton-line skeleton-name"></div>
            </div>
          </div>
          }
        </div>
      </div>
      } @else if (getEmployeeHierarchy().length > 0) {
      <div class="org-chart-wrapper">
        <div class="employee-hierarchy-list">
          @for (emp of getEmployeeHierarchy().slice(0, 4); track $index) {
          <div class="employee-card mb-1" [class.highlighted]="emp.highlighted">
            <div class="hierarchy-arrow" [style.margin-left.px]="emp.level * 20">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                <path d="M4 4 Q 4 16, 16 16 L 28 16" stroke="currentColor" stroke-width="2" fill="none" />
                <path d="M24 12 L 28 16 L 24 20" stroke="currentColor" stroke-width="2" fill="none"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </div>
            <div class="employee-avatar" style="width: 40px; height: 40px;">
              <img [src]="defaultImage" [alt]="emp.name" onerror="this.src='assets/images/default-avatar.png'">
            </div>
            <div class="employee-info">
              <div class="employee-id">{{ emp.code }}</div>
              <div class="employee-name" style="font-size: 14px;">{{ emp.name }}</div>
            </div>
          </div>
          }
        </div>

        <!-- View Full Chart Button -->
        <div class="view-full-chart">
          <button class="btn-view-chart" (click)="navigateToOrgChart()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
              <path fill="currentColor"
                d="M14 3v2h3.59l-9.83 9.83l1.41 1.41L19 6.41V10h2V3m-2 16H5V5h7V3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7h-2z" />
            </svg>
            View Full Chart
          </button>
        </div>
      </div>
      } @else {
      <div class="empty-state py-4">
        <p class="small text-muted mb-0">No organizational data available</p>
      </div>
      }
    </div>
  </div>
  }
</div>

<!-- Organizational Chart Modal -->
@if (isOrgChartModalOpen) {
<div class="org-chart-modal-overlay" (click)="closeOrgChartModal()">
  <div class="org-chart-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Complete Organizational Chart</h2>
      <button class="close-btn" (click)="closeOrgChartModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <path fill="currentColor"
            d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12z" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="org-tree-container">
        @for (root of companyStructure; track $index) {
        <div class="tree-node-wrapper">
          <div class="tree-node root-node">
            <div class="node-avatar">
              <img [src]="defaultImage" [alt]="root.name" onerror="this.src='assets/images/default-avatar.png'">
            </div>
            <div class="node-details">
              <div class="node-code">{{ root.job_title_code }}</div>
              <div class="node-name">{{ root.name }}</div>
              <div class="node-position">{{ root.position }}</div>
              <div class="node-level">{{ root.level }}</div>
            </div>
          </div>

          @if (root.children && root.children.length > 0) {
          <div class="tree-children">
            @for (child of root.children; track $index) {
            <div class="tree-branch">
              <div class="branch-line"></div>
              <div class="tree-node child-node">
                <div class="node-avatar">
                  <img [src]="defaultImage" [alt]="child.name" onerror="this.src='assets/images/default-avatar.png'">
                </div>
                <div class="node-details">
                  <div class="node-code">{{ child.job_title_code }}</div>
                  <div class="node-name">{{ child.name }}</div>
                  <div class="node-position">{{ child.position }}</div>
                  <div class="node-level">{{ child.level }}</div>
                </div>
              </div>

              @if (child.children && child.children.length > 0) {
              <div class="tree-children">
                @for (grandchild of child.children; track $index) {
                <div class="tree-branch">
                  <div class="branch-line"></div>
                  <div class="tree-node child-node">
                    <div class="node-avatar">
                      <img [src]="defaultImage" [alt]="grandchild.name"
                        onerror="this.src='assets/images/default-avatar.png'">
                    </div>
                    <div class="node-details">
                      <div class="node-code">{{ grandchild.job_title_code }}</div>
                      <div class="node-name">{{ grandchild.name }}</div>
                      <div class="node-position">{{ grandchild.position }}</div>
                      <div class="node-level">{{ grandchild.level }}</div>
                    </div>
                  </div>

                  @if (grandchild.children && grandchild.children.length > 0) {
                  <div class="tree-children">
                    @for (ggchild of grandchild.children; track $index) {
                    <div class="tree-branch">
                      <div class="branch-line"></div>
                      <div class="tree-node child-node">
                        <div class="node-avatar">
                          <img [src]="defaultImage" [alt]="ggchild.name"
                            onerror="this.src='assets/images/default-avatar.png'">
                        </div>
                        <div class="node-details">
                          <div class="node-code">{{ ggchild.job_title_code }}</div>
                          <div class="node-name">{{ ggchild.name }}</div>
                          <div class="node-position">{{ ggchild.position }}</div>
                          <div class="node-level">{{ ggchild.level }}</div>
                        </div>
                      </div>

                      @if (ggchild.children && ggchild.children.length > 0) {
                      <div class="tree-children">
                        @for (gggchild of ggchild.children; track $index) {
                        <div class="tree-branch">
                          <div class="branch-line"></div>
                          <div class="tree-node child-node">
                            <div class="node-avatar">
                              <img src="assets/images/default-avatar.png" [alt]="gggchild.name">
                            </div>
                            <div class="node-details">
                              <div class="node-code">{{ gggchild.job_title_code }}</div>
                              <div class="node-name">{{ gggchild.name }}</div>
                              <div class="node-position">{{ gggchild.position }}</div>
                              <div class="node-level">{{ gggchild.level }}</div>
                            </div>
                          </div>
                        </div>
                        }
                      </div>
                      }
                    </div>
                    }
                  </div>
                  }
                </div>
                }
              </div>
              }
            </div>
            }
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>
</div>
}