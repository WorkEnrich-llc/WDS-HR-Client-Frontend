<!-- page header -->
<app-page-header [breadcrumbs]="breadcrumb" [title]="isUpdate ? 'Update Integration' : 'Create Integration'"
    [create]="todayFormatted">
    <button class="btn btn-lg btn-success w-auto"
        [disabled]="isSubmitting || !integrationForm.valid || selectedServices.length === 0" (click)="onSubmit()">
        @if (isSubmitting) {
        <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
        }
        @if (!isSubmitting) {
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
            <g fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10" />
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
            </g>
        </svg>
        }
        <span>{{ isUpdate ? 'Update Integration' : 'Create Integration' }}</span>
    </button>

    <button class="btn btn-lg btn-outline-dark w-auto" (click)="onCancel()">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
            <g fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10" />
                <path stroke-linecap="round" d="m14.5 9.5l-5 5m0-5l5 5" />
            </g>
        </svg>
        <span>{{ isUpdate ? 'Discard Updates' : 'Discard Integration' }}</span>
    </button>
</app-page-header>

<!-- steps navigation -->
<ul class="nav d-flex align-items-center nav-tabs bg-white px-3">
    <li class="nav-item" [ngClass]="{
        'active': currentTab === 'main-info',
        'text-success': currentTab === 'access-apis', 
        'bg-light-success': currentTab === 'access-apis'  
    }">
        @if (currentTab === 'main-info') {
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
            <path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity=".5" />
            <path
                d="M12 17.75a.75.75 0 0 0 .75-.75v-6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75M12 7a1 1 0 1 1 0 2a1 1 0 0 1 0-2" />
        </svg>
        }
        @if (currentTab === 'access-apis') {
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
            [style.fill]="currentTab === 'access-apis' ? 'currentColor' : '#4A6D97'">
            <path d="M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12S6.477 2 12 2s10 4.477 10 10" opacity=".5" />
            <path
                d="M16.03 8.97a.75.75 0 0 1 0 1.06l-5 5a.75.75 0 0 1-1.06 0l-2-2a.75.75 0 1 1 1.06-1.06l1.47 1.47l2.235-2.235L14.97 8.97a.75.75 0 0 1 1.06 0" />
        </svg>
        }
        <span class="nav-link">Main Info</span>
    </li>

    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" [style.fill]="
    currentTab === 'main-info' ? '#DDE3EB' :
    currentTab === 'access-apis' ? '#377AFD' :
    '#DDE3EB'
  ">
        <path
            d="M15.835 11.63L9.205 5.2C8.79 4.799 8 5.042 8 5.57v12.86c0 .528.79.771 1.205.37l6.63-6.43a.5.5 0 0 0 0-.74" />
    </svg>

    <li class="nav-item" [ngClass]="{
        'active': currentTab === 'access-apis',
        'text-success': false, 
        'bg-light-success': false  
    }">
        @if (currentTab === 'main-info') {
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"
            [style.fill]="currentTab === 'main-info' ? '#007bff' : '#4A6D97'">
            <polygon
                points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
        </svg>
        }
        @if (currentTab === 'access-apis') {
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path opacity="0.3"
                d="M16.5 9C16.5 13.1421 13.1421 16.5 9 16.5C4.85786 16.5 1.5 13.1421 1.5 9C1.5 4.85786 4.85786 1.5 9 1.5C13.1421 1.5 16.5 4.85786 16.5 9Z"
                fill="#4A6D97" />
            <path
                d="M9.00014 6.75C9.82857 6.75 10.5001 6.07843 10.5001 5.25C10.5001 4.42157 9.82857 3.75 9.00014 3.75C8.17172 3.75 7.50015 4.42157 7.50015 5.25C7.50015 6.07843 8.17172 6.75 9.00014 6.75Z"
                fill="#4A6D97" />
            <path
                d="M4.71963 6.98209C4.43365 6.86089 4.10355 6.99443 3.98228 7.2804C3.861 7.56641 3.99454 7.89658 4.28054 8.01786L4.28154 8.01828L4.2835 8.01911L4.29028 8.02196L4.31503 8.03228C4.33639 8.04113 4.36735 8.05385 4.40706 8.06989C4.48645 8.10196 4.60094 8.14735 4.74373 8.2016C5.02898 8.30999 5.4289 8.45444 5.88872 8.59908C6.63037 8.83237 7.56602 9.07865 8.43764 9.15981V10.0892C8.43764 10.4128 8.34461 10.7295 8.16963 11.0017L6.27698 13.9458C6.10899 14.2071 6.18465 14.5552 6.44597 14.7232C6.70729 14.8912 7.05532 14.8155 7.22331 14.5542L9.00015 11.7902L10.777 14.5542C10.945 14.8155 11.293 14.8912 11.5543 14.7232C11.8156 14.5552 11.8913 14.2071 11.7233 13.9458L9.83066 11.0017C9.65568 10.7295 9.56264 10.4128 9.56264 10.0892V9.15981C10.4343 9.07865 11.3699 8.83237 12.1116 8.59908C12.5714 8.45444 12.9713 8.30999 13.2566 8.2016C13.3993 8.14735 13.5138 8.10196 13.5932 8.06989C13.6329 8.05385 13.6639 8.04113 13.6853 8.03228L13.71 8.02196L13.7168 8.01911L13.7188 8.01828L13.7196 8.01793C14.0056 7.89665 14.1393 7.56641 14.018 7.2804C13.8967 6.99442 13.5665 6.86093 13.2805 6.98214L13.2749 6.98449L13.2545 6.99299C13.2361 7.00062 13.2083 7.01207 13.1719 7.02679C13.0989 7.05624 12.9917 7.09875 12.857 7.14996C12.5871 7.25251 12.2083 7.38931 11.774 7.52592C10.8904 7.80387 9.83358 8.0625 9.00014 8.0625C8.16671 8.0625 7.10993 7.80387 6.22629 7.52592C5.79198 7.38931 5.41322 7.25251 5.14332 7.14996C5.00854 7.09875 4.90134 7.05624 4.82844 7.02679C4.79199 7.01207 4.76415 7.00062 4.74575 6.99299L4.72534 6.98449L4.72065 6.98252L4.71963 6.98209Z"
                fill="#4A6D97" />
        </svg>

        }
        <span class="nav-link">Access APIs</span>
    </li>
</ul>

<!-- step 1 -->
@if (currentTab === 'main-info') {
<div class="content-hug">
    <div class="content-box d-flex flex-column gap-3">
        <h2>Main Information</h2>

        <!-- Skeleton Loader for Update Mode -->
        @if (isUpdate && isLoadingDetails) {
        <div class="w-lg-50">
            <app-skelaton-loading [rows]="3" [hasLabel]="true" [labelHeight]="14"
                [valueHeight]="48"></app-skelaton-loading>
        </div>
        }

        <!-- Form Content -->
        @if (!isLoadingDetails) {
        <form [formGroup]="integrationForm" class="w-lg-50 d-flex flex-column gap-2">
            <div class="input">
                <label for="integrationName">Name <span>*</span></label>
                <div class="form-outline w-100 position-relative custom-date-wrapper">
                    <input formControlName="name" type="text" id="integrationName"
                        class="form-control custom-date-input" placeholder="Enter integration name" />
                </div>
                @if (integrationForm.get('name')?.touched && integrationForm.get('name')?.errors?.['required']) {
                <p class="error-msg">
                    Integration name is required.
                </p>
                }

            </div>

            <div class="input">
                <label for="startDate">Start Date <span>*</span></label>
                <div class="form-outline w-100 position-relative custom-date-wrapper">
                    <input formControlName="startDate" type="date" id="startDate"
                        class="form-control custom-date-input" />
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_588_3981)">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M5.25 1.3125C5.56066 1.3125 5.8125 1.56434 5.8125 1.875V2.44704C6.30902 2.43749 6.85605 2.43749 7.45769 2.4375H10.5423C11.1439 2.43749 11.691 2.43749 12.1875 2.44704V1.875C12.1875 1.56434 12.4393 1.3125 12.75 1.3125C13.0607 1.3125 13.3125 1.56434 13.3125 1.875V2.49532C13.5075 2.51018 13.6921 2.52886 13.8668 2.55235C14.7461 2.67057 15.4578 2.91966 16.0191 3.48093C16.5803 4.0422 16.8294 4.75392 16.9476 5.63323C16.9854 5.91425 17.0108 6.22094 17.0278 6.55505C17.0502 6.61579 17.0625 6.68146 17.0625 6.75C17.0625 6.80199 17.0554 6.85233 17.0422 6.90012C17.0625 7.50161 17.0625 8.18456 17.0625 8.95769V10.5C17.0625 10.8107 16.8107 11.0625 16.5 11.0625C16.1893 11.0625 15.9375 10.8107 15.9375 10.5V9C15.9375 8.35949 15.9373 7.80205 15.9277 7.3125H2.07231C2.06274 7.80205 2.0625 8.35949 2.0625 9V10.5C2.0625 11.9301 2.0637 12.9461 2.16732 13.7169C2.26877 14.4714 2.45902 14.9062 2.77643 15.2236C3.09384 15.541 3.52857 15.7312 4.28314 15.8327C5.05388 15.9363 6.06988 15.9375 7.5 15.9375H10.5C10.8107 15.9375 11.0625 16.1893 11.0625 16.5C11.0625 16.8107 10.8107 17.0625 10.5 17.0625H7.45769C6.07937 17.0625 4.98764 17.0625 4.13323 16.9476C3.25392 16.8294 2.5422 16.5803 1.98093 16.0191C1.41966 15.4578 1.17057 14.7461 1.05235 13.8668C0.937479 13.0124 0.937488 11.9206 0.9375 10.5423V8.95769C0.937494 8.18456 0.937488 7.50161 0.957757 6.90013C0.944554 6.85233 0.937501 6.80199 0.937501 6.75C0.937501 6.68146 0.949758 6.61579 0.972202 6.55505C0.989216 6.22094 1.01457 5.91425 1.05235 5.63323C1.17057 4.75392 1.41966 4.0422 1.98093 3.48093C2.54221 2.91966 3.25392 2.67057 4.13323 2.55235C4.30793 2.52886 4.49254 2.51018 4.6875 2.49532V1.875C4.6875 1.56434 4.93934 1.3125 5.25 1.3125ZM2.12376 6.1875H15.8762C15.8642 6.04546 15.8499 5.91093 15.8327 5.78314C15.7312 5.02857 15.541 4.59383 15.2236 4.27643C14.9062 3.95902 14.4714 3.76877 13.7169 3.66732C12.9461 3.56369 11.9301 3.5625 10.5 3.5625H7.5C6.06989 3.5625 5.05388 3.56369 4.28314 3.66732C3.52857 3.76877 3.09384 3.95902 2.77643 4.27643C2.45902 4.59383 2.26877 5.02857 2.16732 5.78314C2.15014 5.91093 2.13577 6.04546 2.12376 6.1875ZM13.5 11.8125C12.568 11.8125 11.8125 12.568 11.8125 13.5C11.8125 14.432 12.568 15.1875 13.5 15.1875C14.432 15.1875 15.1875 14.432 15.1875 13.5C15.1875 12.568 14.432 11.8125 13.5 11.8125ZM10.6875 13.5C10.6875 11.9467 11.9467 10.6875 13.5 10.6875C15.0533 10.6875 16.3125 11.9467 16.3125 13.5C16.3125 14.0732 16.141 14.6064 15.8465 15.051L16.8977 16.1023C17.1174 16.3219 17.1174 16.6781 16.8977 16.8977C16.6781 17.1174 16.3219 17.1174 16.1023 16.8977L15.051 15.8465C14.6064 16.141 14.0732 16.3125 13.5 16.3125C11.9467 16.3125 10.6875 15.0533 10.6875 13.5Z"
                                fill="#4A6D97" />
                        </g>
                        <defs>
                            <clipPath id="clip0_588_3981">
                                <rect width="18" height="18" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>

                </div>
                @if (integrationForm.get('startDate')?.touched &&
                integrationForm.get('startDate')?.errors?.['required']) {
                <p class="error-msg">
                    Start date is required.
                </p>
                }
            </div>

            <div class="input mt-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" formControlName="hasExpiryDate" id="hasExpiryDate"
                        (change)="onExpiryDateChange()">
                    <label class="form-check-label" for="hasExpiryDate">
                        Expiry Date
                    </label>
                </div>
            </div>

            @if (integrationForm.get('hasExpiryDate')?.value) {
            <div class="input">
                <label for="expiryDate">Expiry Date <span>*</span></label>
                <div class="form-outline w-100 position-relative custom-date-wrapper">
                    <input formControlName="expiryDate" type="date" id="expiryDate"
                        class="form-control custom-date-input" />
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                @if (integrationForm.get('expiryDate')?.touched &&
                integrationForm.get('expiryDate')?.errors?.['required']) {
                <p class="error-msg">
                    Expiry date is required.
                </p>
                }
            </div>
            }
        </form>
        }

        <!-- next button -->
        @if (!isLoadingDetails) {
        <div class="btn-fixed">
            <button class="btn btn-lg btn-primary" [disabled]="!isFormValidForNext()" (click)="goToNextTab()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                        stroke-width="1.5" d="M4 12h16m0 0l-6-6m6 6l-6 6" />
                </svg>
                <span>Next (1/2)</span>
            </button>
        </div>
        }
    </div>
</div>
}

<!-- step 2 -->
@if (currentTab === 'access-apis') {
<div class="content-hug">
    <div class="content-box d-flex flex-column gap-3">
        <h2>Access APIs</h2>

        <!-- Skeleton Loader for Update Mode -->
        @if (isUpdate && isLoadingDetails) {
        <div class="w-100">
            <app-skelaton-loading [rows]="5" [hasLabel]="false" [valueHeight]="60"></app-skelaton-loading>
        </div>
        }

        <!-- Content -->
        @if (!isLoadingDetails) {
        <!-- Service Selection Error Alert -->
        @if (showServiceError) {
        <div class="alert alert-danger d-flex align-items-center gap-2 mb-3" role="alert"
            style="background-color: #f8d7da; border-color: #f5c6cb; color: #721c24;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>{{ getServiceErrorMessage() }}</span>
        </div>
        }

        <!-- Add Services Link -->
        <a class="add-service-link" (click)="openServiceFilter()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>Add Services</span>
        </a>

        <!-- Selected Services Table -->
        @if (selectedServices.length > 0) {
        <div class="services-list-table">
            <app-table [data]="getSelectedServicesForTable()" [currentPage]="1" [isLoading]="false" [columnsCount]="3"
                [headerTemplate]="selectedServicesHeaderTemplate" [rowTemplate]="selectedServicesRowTemplate"
                [emptyTemplate]="selectedServicesEmptyTemplate" [disablePagination]="true">
            </app-table>
        </div>
        } @else {
        <div class="empty-state">
            <p class="text-muted mb-0">No services selected. Click "Add Services" to get started.</p>
        </div>
        }

        <!-- Table Templates -->
        <ng-template #selectedServicesHeaderTemplate>
            <th>
                <div class="service-only-header-inner">
                    <span>Service</span>
                </div>
            </th>
            <th>
                <div class="service-only-header-inner">
                    <span>Count</span>
                </div>
            </th>
            <th style="width: 100px;">
                <div class="service-only-header-inner">
                    <span>Action</span>
                </div>
            </th>
        </ng-template>

        <ng-template #selectedServicesRowTemplate let-service>
            <td>
                <div class="service-row">
                    <div class="service-name-text">{{ service.serviceName }}</div>
                </div>
            </td>
            <td>
                <div class="service-row">
                    <div class="service-name-text">
                        @if (service.serviceName === 'Sections') {
                        {{ service.count }} section{{ service.count !== 1 ? 's' : '' }}
                        } @else {
                        {{ service.count }} {{ service.serviceName.toLowerCase() }}{{ service.count !== 1 ? 's' : '' }}
                        }
                    </div>
                </div>
            </td>
            <td class="text-end">
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <button class="btn btn-sm btn-primary" (click)="openItemsSelection(service.service)"
                        [title]="'Select ' + service.serviceName.toLowerCase() + ' for this service'">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="removeService(service.serviceName)"
                        title="Remove this service">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </td>
        </ng-template>

        <ng-template #selectedServicesEmptyTemplate>
            <tr>
                <td colspan="3" class="text-center py-4">
                    <div class="empty-state">
                        <p class="text-muted mb-0">No services selected.</p>
                    </div>
                </td>
            </tr>
        </ng-template>
        }
    </div>
</div>
}

<!-- Overlay Filter Box for Service Selection -->
<app-overlay-filter-box #serviceFilterBox [title]="'Select Services'">
    <div class="w-100 d-flex flex-column gap-3" style="max-height: 80vh; overflow-y: auto;">
        <!-- Service Selection Error Alert -->
        @if (showServiceError) {
        <div class="alert alert-danger d-flex align-items-center gap-2 mb-3" role="alert"
            style="background-color: #f8d7da; border-color: #f5c6cb; color: #721c24;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>{{ getServiceErrorMessage() }}</span>
        </div>
        }

        <!-- Search and Filter -->
        <div class="search-filter-grid mb-3">
            <div class="form-outline position-relative">
                <input type="text" class="form-control custom-date-input" placeholder="Search Services"
                    [(ngModel)]="featureSearchTerm" (input)="filterFeatures()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                    <g clip-path="url(#clip0_search_features)">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M8.625 2.0625C5.00063 2.0625 2.0625 5.00063 2.0625 8.625C2.0625 12.2494 5.00063 15.1875 8.625 15.1875C12.2494 15.1875 15.1875 12.2494 15.1875 8.625C15.1875 5.00063 12.2494 2.0625 8.625 2.0625ZM0.9375 8.625C0.9375 4.37931 4.37931 0.9375 8.625 0.9375C12.8707 0.9375 16.3125 4.37931 16.3125 8.625C16.3125 10.5454 15.6083 12.3013 14.4441 13.6487L16.8977 16.1023C17.1174 16.3219 17.1174 16.6781 16.8977 16.8977C16.6781 17.1174 16.3219 17.1174 16.1023 16.8977L13.6487 14.4441C12.3013 15.6083 10.5454 16.3125 8.625 16.3125C4.37931 16.3125 0.9375 12.8707 0.9375 8.625Z"
                            fill="#4A6D97" />
                    </g>
                    <defs>
                        <clipPath id="clip0_search_features">
                            <rect width="18" height="18" fill="white" />
                        </clipPath>
                    </defs>
                </svg>
            </div>
        </div>

        <!-- Services List -->
        @if (isLoadingFeatures) {
        <div class="w-100">
            <app-skelaton-loading [rows]="5" [hasLabel]="false" [valueHeight]="60"></app-skelaton-loading>
        </div>
        } @else {
        <div class="services-list-table">
            <table class="table">
                <thead class="service-only-header">
                    <tr>
                        <th colspan="2">
                            <div class="service-only-header-inner">
                                <span>Select Service</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @for (feature of getFilteredFeatures(); track feature.name) {
                    <tr (click)="toggleServiceSelection(feature)">
                        <td colspan="2">
                            <div class="service-row">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="checkbox" class="service-square-checkbox"
                                        [checked]="isServiceSelected(feature.name)"
                                        (click)="$event.stopPropagation(); toggleServiceSelection(feature)">
                                    <div>
                                        <div class="service-module-label">Service</div>
                                        <div class="service-name-text">
                                            {{ feature.name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }


        <!-- Action Buttons -->
        <div class="d-flex align-items-center gap-3 pt-4">
            <button type="button" class="btn btn-lg btn-primary w-100" (click)="confirmServiceSelection()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12.0227 7.52275C12.2424 7.30308 12.2424 6.94692 12.0227 6.72725C11.8031 6.50758 11.4469 6.50758 11.2273 6.72725L7.875 10.0795L6.77275 8.97725C6.55308 8.75758 6.19692 8.75758 5.97725 8.97725C5.75758 9.19692 5.75758 9.55308 5.97725 9.77275L7.47725 11.2727C7.69692 11.4924 8.05308 11.4924 8.27275 11.2727L12.0227 7.52275Z"
                        fill="#E0EBFF" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M9 0.9375C4.5472 0.9375 0.9375 4.5472 0.9375 9C0.9375 13.4528 4.5472 17.0625 9 17.0625C13.4528 17.0625 17.0625 13.4528 17.0625 9C17.0625 4.5472 13.4528 0.9375 9 0.9375ZM2.0625 9C2.0625 5.16852 5.16852 2.0625 9 2.0625C12.8315 2.0625 15.9375 5.16852 15.9375 9C15.9375 12.8315 12.8315 15.9375 9 15.9375C5.16852 15.9375 2.0625 12.8315 2.0625 9Z"
                        fill="#E0EBFF" />
                </svg>
                <span>Confirm</span>
            </button>
            <a (click)="closeServiceFilter()" class="text-danger-dark fw-bold w-100 text-center cursor-pointer">
                <span>Discard</span>
            </a>
        </div>
    </div>
</app-overlay-filter-box>

<!-- Second Overlay: Items Selection for a Specific Service -->
<app-overlay-filter-box #itemsFilterBox [title]="'Select Items for ' + (editingService?.feature?.name || 'Service')">
    <div class="w-100 d-flex flex-column gap-3" style="max-height: 80vh; overflow-y: auto;">
        @if (editingService) {
        @if (editingService.feature.name === 'Sections') {
        <!-- Sections: Show Departments First -->
        @if (!selectedDepartment) {
        <div class="search-filter-grid mb-3">
            <div class="form-outline position-relative">
                <input type="text" class="form-control custom-date-input" placeholder="Search Departments"
                    [(ngModel)]="departmentsSearchTerm" (input)="onDepartmentsSearch()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                    <g clip-path="url(#clip0_search_dept)">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M8.625 2.0625C5.00063 2.0625 2.0625 5.00063 2.0625 8.625C2.0625 12.2494 5.00063 15.1875 8.625 15.1875C12.2494 15.1875 15.1875 12.2494 15.1875 8.625C15.1875 5.00063 12.2494 2.0625 8.625 2.0625ZM0.9375 8.625C0.9375 4.37931 4.37931 0.9375 8.625 0.9375C12.8707 0.9375 16.3125 4.37931 16.3125 8.625C16.3125 10.5454 15.6083 12.3013 14.4441 13.6487L16.8977 16.1023C17.1174 16.3219 17.1174 16.6781 16.8977 16.8977C16.6781 17.1174 16.3219 17.1174 16.1023 16.8977L13.6487 14.4441C12.3013 15.6083 10.5454 16.3125 8.625 16.3125C4.37931 16.3125 0.9375 12.8707 0.9375 8.625Z"
                            fill="#4A6D97" />
                    </g>
                    <defs>
                        <clipPath id="clip0_search_dept">
                            <rect width="18" height="18" fill="white" />
                        </clipPath>
                    </defs>
                </svg>
            </div>
        </div>
        @if (isLoadingDepartments) {
        <div class="w-100">
            <app-skelaton-loading [rows]="5" [hasLabel]="false" [valueHeight]="60"></app-skelaton-loading>
        </div>
        } @else {
        <div class="services-list-table">
            <table class="table">
                <thead class="service-only-header">
                    <tr>
                        <th colspan="2">
                            <div class="service-only-header-inner">
                                <span>Select Department</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @for (dept of getDepartmentsList(); track $index) {
                    <tr (click)="selectDepartment(dept)">
                        <td colspan="2">
                            <div class="service-row">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="checkbox" class="service-square-checkbox"
                                        [checked]="isDepartmentSelected(dept)" readonly>
                                    <div>
                                        <div class="service-module-label">Department</div>
                                        <div class="service-name-text">{{ dept.name }}</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }
        }

        <!-- Sections: Show Sections for Selected Department -->
        @if (selectedDepartment) {
        <div class="d-flex flex-column gap-2 mt-4">
            <div class="search-filter-grid mb-3">
                <div class="form-outline position-relative">
                    <input type="text" class="form-control custom-date-input" placeholder="Search Sections"
                        [(ngModel)]="sectionsSearchTerm" (input)="onSectionsSearch()">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                        style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                        <g clip-path="url(#clip0_search_sections)">
                            <path fill-rule="evenodd" clip-rule="evenodd"
                                d="M8.625 2.0625C5.00063 2.0625 2.0625 5.00063 2.0625 8.625C2.0625 12.2494 5.00063 15.1875 8.625 15.1875C12.2494 15.1875 15.1875 12.2494 15.1875 8.625C15.1875 5.00063 12.2494 2.0625 8.625 2.0625ZM0.9375 8.625C0.9375 4.37931 4.37931 0.9375 8.625 0.9375C12.8707 0.9375 16.3125 4.37931 16.3125 8.625C16.3125 10.5454 15.6083 12.3013 14.4441 13.6487L16.8977 16.1023C17.1174 16.3219 17.1174 16.6781 16.8977 16.8977C16.6781 17.1174 16.3219 17.1174 16.1023 16.8977L13.6487 14.4441C12.3013 15.6083 10.5454 16.3125 8.625 16.3125C4.37931 16.3125 0.9375 12.8707 0.9375 8.625Z"
                                fill="#4A6D97" />
                        </g>
                        <defs>
                            <clipPath id="clip0_search_sections">
                                <rect width="18" height="18" fill="white" />
                            </clipPath>
                        </defs>
                    </svg>
                </div>
            </div>
            @if (isLoadingSections) {
            <div class="w-100">
                <app-skelaton-loading [rows]="5" [hasLabel]="false" [valueHeight]="60"></app-skelaton-loading>
            </div>
            } @else {
            <div class="services-list-table">
                <table class="table">
                    <thead class="service-only-header">
                        <tr>
                            <th colspan="2">
                                <div class="service-only-header-inner">
                                    <input type="checkbox" class="service-square-checkbox"
                                        [checked]="isAllSectionsSelected()" (click)="toggleSelectAllSections()">
                                    <span>Select All {{ editingService?.feature?.name || 'Sections' }}</span>
                                    @if (selectedSections.length > 0) {
                                    <span class="badge bg-info ms-2">{{ selectedSections.length }} selected</span>
                                    }
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (section of getFilteredSections(); track $index) {
                        <tr (click)="toggleSectionSelection(section)">
                            <td colspan="2">
                                <div class="service-row">
                                    <div class="d-flex align-items-center gap-2">
                                        <input type="checkbox" class="service-square-checkbox"
                                            [checked]="isSectionSelected(section)"
                                            (click)="$event.stopPropagation(); toggleSectionSelection(section)">
                                        <div>
                                            <div class="service-module-label">Section</div>
                                            <div class="service-name-text">{{ section.name }}</div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
            }
        </div>
        }
        } @else {
        <!-- Other Services: Show Items -->
        <div class="search-filter-grid mb-3">
            <div class="form-outline position-relative">
                <input type="text" class="form-control custom-date-input" placeholder="Search Items"
                    [(ngModel)]="itemsSearchTerm" (input)="onItemsSearch()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                    style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                    <g clip-path="url(#clip0_search_items)">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M8.625 2.0625C5.00063 2.0625 2.0625 5.00063 2.0625 8.625C2.0625 12.2494 5.00063 15.1875 8.625 15.1875C12.2494 15.1875 15.1875 12.2494 15.1875 8.625C15.1875 5.00063 12.2494 2.0625 8.625 2.0625ZM0.9375 8.625C0.9375 4.37931 4.37931 0.9375 8.625 0.9375C12.8707 0.9375 16.3125 4.37931 16.3125 8.625C16.3125 10.5454 15.6083 12.3013 14.4441 13.6487L16.8977 16.1023C17.1174 16.3219 17.1174 16.6781 16.8977 16.8977C16.6781 17.1174 16.3219 17.1174 16.1023 16.8977L13.6487 14.4441C12.3013 15.6083 10.5454 16.3125 8.625 16.3125C4.37931 16.3125 0.9375 12.8707 0.9375 8.625Z"
                            fill="#4A6D97" />
                    </g>
                    <defs>
                        <clipPath id="clip0_search_items">
                            <rect width="18" height="18" fill="white" />
                        </clipPath>
                    </defs>
                </svg>
            </div>
        </div>
        @if (isLoadingItems) {
        <div class="w-100">
            <app-skelaton-loading [rows]="5" [hasLabel]="false" [valueHeight]="60"></app-skelaton-loading>
        </div>
        } @else {
        <div class="services-list-table">
            <table class="table">
                <thead class="service-only-header">
                    <tr>
                        <th colspan="2">
                            <div class="service-only-header-inner">
                                <input type="checkbox" class="service-square-checkbox" [checked]="isAllItemsSelected()"
                                    (click)="toggleSelectAllItems()">
                                <span>Select All {{ editingService?.feature?.name || 'Items' }}</span>
                                @if (selectedItems.length > 0) {
                                <span class="badge bg-info ms-2">{{ selectedItems.length }} selected</span>
                                }
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @for (item of getItemsPage(); track $index) {
                    <tr (click)="toggleItemSelection(item)">
                        <td colspan="2">
                            <div class="service-row">
                                <div class="d-flex align-items-center gap-2">
                                    <input type="checkbox" class="service-square-checkbox"
                                        [checked]="isItemSelected(item)"
                                        (click)="$event.stopPropagation(); toggleItemSelection(item)">
                                    <div>
                                        <div class="service-module-label">{{ editingService?.feature?.name || 'Item' }}
                                        </div>
                                        <div class="service-name-text">{{ item.name }}</div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
        }
        }
        }

        <!-- Action Buttons -->
        <div class="d-flex align-items-center gap-3 pt-4">
            <button type="button" class="btn btn-lg btn-primary w-100" (click)="confirmItemsSelection()">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12.0227 7.52275C12.2424 7.30308 12.2424 6.94692 12.0227 6.72725C11.8031 6.50758 11.4469 6.50758 11.2273 6.72725L7.875 10.0795L6.77275 8.97725C6.55308 8.75758 6.19692 8.75758 5.97725 8.97725C5.75758 9.19692 5.75758 9.55308 5.97725 9.77275L7.47725 11.2727C7.69692 11.4924 8.05308 11.4924 8.27275 11.2727L12.0227 7.52275Z"
                        fill="#E0EBFF" />
                    <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M9 0.9375C4.5472 0.9375 0.9375 4.5472 0.9375 9C0.9375 13.4528 4.5472 17.0625 9 17.0625C13.4528 17.0625 17.0625 13.4528 17.0625 9C17.0625 4.5472 13.4528 0.9375 9 0.9375ZM2.0625 9C2.0625 5.16852 5.16852 2.0625 9 2.0625C12.8315 2.0625 15.9375 5.16852 15.9375 9C15.9375 12.8315 12.8315 15.9375 9 15.9375C5.16852 15.9375 2.0625 12.8315 2.0625 9Z"
                        fill="#E0EBFF" />
                </svg>
                <span>Confirm</span>
            </button>
            <a (click)="closeItemsFilter()" class="text-danger-dark fw-bold w-100 text-center cursor-pointer">
                <span>Discard</span>
            </a>
        </div>
    </div>
</app-overlay-filter-box>

<!-- Fixed actions for Access APIs -->
<div class="btn-fixed" *ngIf="currentTab === 'access-apis' && !isLoadingDetails">
    <div class="d-flex align-items-center gap-2">
        <!-- Back square button -->
        <button class="btn back-square-btn" (click)="goBackToMainInfo()" title="Back">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                <path fill="none" stroke="#4A6D97" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M15 5l-6 7l6 7" />
            </svg>
        </button>
        <!-- Create/Update Integration primary -->
        <button class="btn btn-lg btn-success" [disabled]="isSubmitting || selectedServices.length === 0"
            (click)="onSubmit()">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="m8.5 12.5l2 2l5-5" />
                </g>
            </svg>
            <span>{{ isUpdate ? 'Update Integration' : 'Create Integration' }}</span>
        </button>
    </div>
</div>

<!-- Table Templates -->
<!-- Services Table Templates -->
<ng-template #featuresHeaderTemplate>
    <th>Service</th>
</ng-template>

<ng-template #featuresRowTemplate let-feature>
    <td>
        <div class="d-flex align-items-center gap-2 cursor-pointer" (click)="selectFeature(feature)"
            style="cursor: pointer; padding: 8px;">
            <span>{{ feature.name }}</span>
        </div>
    </td>
</ng-template>

<ng-template #featuresEmptyTemplate>
    <tr>
        <td class="text-center py-4">
            <div class="empty-state">
                <p class="text-muted mb-0">No services found.</p>
            </div>
        </td>
    </tr>
</ng-template>

<!-- Items Table Templates -->
<ng-template #itemsHeaderTemplate>
    <th>
        <div class="d-flex align-items-center gap-2">
            <span>Item</span>
        </div>
    </th>
</ng-template>

<ng-template #itemsRowTemplate let-item>
    <td>
        <div class="d-flex align-items-center gap-2" (click)="toggleItemSelection(item)" style="cursor: pointer;">
            <input type="checkbox" [checked]="isItemSelected(item)"
                (click)="$event.stopPropagation(); toggleItemSelection(item)">
            <span>{{ item.name }}</span>
            @if (item.code) {
            <span class="text-muted">({{ item.code }})</span>
            }
        </div>
    </td>
</ng-template>

<ng-template #itemsEmptyTemplate>
    <tr>
        <td class="text-center py-4">
            <div class="empty-state">
                <p class="text-muted mb-0">No items found.</p>
            </div>
        </td>
    </tr>
</ng-template>

<!-- Departments Table Templates -->
<ng-template #departmentsHeaderTemplate>
    <th>Department</th>
</ng-template>

<ng-template #departmentsRowTemplate let-department>
    <td>
        <div class="d-flex align-items-center gap-2 cursor-pointer" (click)="selectDepartment(department)"
            style="cursor: pointer; padding: 8px;">
            <span>{{ department.name }}</span>
            @if (department.code) {
            <span class="text-muted">({{ department.code }})</span>
            }
        </div>
    </td>
</ng-template>

<ng-template #departmentsEmptyTemplate>
    <tr>
        <td class="text-center py-4">
            <div class="empty-state">
                <p class="text-muted mb-0">No departments found.</p>
            </div>
        </td>
    </tr>
</ng-template>

<!-- Sections Table Templates -->
<ng-template #sectionsHeaderTemplate>
    <th>
        <div class="d-flex align-items-center gap-2">
            <span>Section</span>
        </div>
    </th>
</ng-template>

<ng-template #sectionsRowTemplate let-section>
    <td>
        <div class="d-flex align-items-center gap-2" (click)="toggleSectionSelection(section)" style="cursor: pointer;">
            <input type="checkbox" [checked]="isSectionSelected(section)"
                (click)="$event.stopPropagation(); toggleSectionSelection(section)">
            <span>{{ section.name }}</span>
            @if (section.code) {
            <span class="text-muted">({{ section.code }})</span>
            }
        </div>
    </td>
</ng-template>

<ng-template #sectionsEmptyTemplate>
    <tr>
        <td class="text-center py-4">
            <div class="empty-state">
                <p class="text-muted mb-0">No sections found.</p>
            </div>
        </td>
    </tr>
</ng-template>

<!-- Summary Table Templates -->
<ng-template #summaryHeaderTemplate>
    <th>Name</th>
    <th class="text-end">Code</th>
</ng-template>

<ng-template #summaryRowTemplate let-item>
    <td>{{ item.name }}</td>
    <td class="text-end">{{ item.code || '-' }}</td>
</ng-template>

<ng-template #summaryEmptyTemplate>
    <tr>
        <td colspan="2" class="text-center py-4">
            <div class="empty-state">
                <p class="text-muted mb-0">No items selected.</p>
            </div>
        </td>
    </tr>
</ng-template>

<!-- end page content -->