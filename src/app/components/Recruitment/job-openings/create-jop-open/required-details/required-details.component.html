<div class="content-hug">
    @for (category of categories; track category.name; let catIndex = $index) {
    <div class="content-box d-flex flex-column gap-3" [class.mt-4]="catIndex > 0">
        <h2>{{ category.name }}</h2>

        @for (subCategory of category.subCategories; track subCategory.name; let subIndex = $index) {
        <div [class.pb-3]="subIndex < category.subCategories.length - 1"
            [class.border-bottom]="subIndex < category.subCategories.length - 1">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h6>{{ subCategory.name }}</h6>
                <button class="btn add-field-btn" (click)="openAddFieldModal(catIndex, subIndex)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M11 13H5v-2h6V5h2v6h6v2h-6v6h-2z" />
                    </svg>
                    Add Field
                </button>
            </div>

            <div class="row">
                @for (field of subCategory.fields; track field.name; let fieldIndex = $index) {
                <div class="col-6 col-md-4 col-lg-2 mb-3">
                    <div class="d-flex flex-column gap-2">
                        <!-- Enable Checkbox -->
                        <div class="form-check d-flex align-items-center justify-content-start p-0 m-0 gap-2">
                            <input class="form-check-input m-0" type="checkbox"
                                [id]="'field-' + catIndex + '-' + subIndex + '-' + fieldIndex"
                                [(ngModel)]="field.enabled" (ngModelChange)="toggleFieldEnabled(field)"
                                [disabled]="field.system && (field.name === 'Name' || field.name === 'Email' || field.name === 'Phone Number')">
                            <label class="form-check-label m-0 d-flex align-items-center gap-1"
                                [for]="'field-' + catIndex + '-' + subIndex + '-' + fieldIndex">
                                <span>{{ field.name }}</span>
                                @if (!field.system) {
                                <button class="btn btn-link p-0 text-danger delete-field-btn"
                                    (click)="removeCustomField(catIndex, subIndex, fieldIndex)" title="Remove field">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                        <path fill="currentColor"
                                            d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z" />
                                    </svg>
                                </button>
                                }
                            </label>
                        </div>

                        <!-- Required Toggle (appears when field is enabled, except for Name, Email, and Phone Number) -->
                        @if (field.enabled && field.name !== 'Name' && field.name !== 'Email' && field.name !== 'Phone
                        Number') {
                        <div class="required-toggle-row d-flex align-items-center p-0 m-0 gap-0">
                            <span class="required-label">Required</span>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input required-toggle m-0" type="checkbox"
                                    [id]="'req-' + catIndex + '-' + subIndex + '-' + fieldIndex"
                                    [(ngModel)]="field.required" (change)="toggleFieldRequired(field)"
                                    title="Mark as required for applicants">
                            </div>
                        </div>
                        }
                    </div>
                </div>
                }
            </div>
        </div>
        }
    </div>
    }

    <!-- Navigation Buttons -->
    <div class="btn-fixed d-flex align-items-stretch gap-2 mt-4">
        <button type="button" class="btn btn-outline-success bg-white d-flex justify-content-center align-items-center"
            (click)="goToPrevStep()">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="1.5" d="M20 12H4m0 0l6-6m-6 6l6 6" />
            </svg>
        </button>
        <button type="button" class="btn btn-lg btn-primary" (click)="goToNextStep()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="1.5" d="M4 12h16m0 0l-6-6m6 6l-6 6" />
            </svg>
            <span>Next (2/3)</span>
        </button>
    </div>
</div>

<!-- Add Field Modal -->
@if (showAddFieldModal) {
<div class="modal-backdrop fade-in show" (click)="closeAddFieldModal()"></div>
<div class="modal fade-in show d-block" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add {{ currentCategoryName }} Field</h5>
                <button type="button" class="btn-close" (click)="closeAddFieldModal()"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="fieldName" class="form-label">Field Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="fieldName" [(ngModel)]="newFieldName"
                        placeholder="Enter field name" (keyup.enter)="addCustomField()" />
                </div>
                <div class="mb-3">
                    <label for="fieldType" class="form-label">Field Type <span class="text-danger">*</span></label>
                    <select class="form-select" id="fieldType" [(ngModel)]="newFieldType">
                        @for (type of fieldTypes; track type) {
                        <option [value]="type">{{ type }}</option>
                        }
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" (click)="closeAddFieldModal()">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="addCustomField()"
                    [disabled]="!newFieldName.trim()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M11 13H5v-2h6V5h2v6h6v2h-6v6h-2z" />
                    </svg>
                    Add Field
                </button>
            </div>
        </div>
    </div>
</div>
}

<!-- Delete Field Confirmation Popup -->
<app-popup [title]="'Delete Field'" [paragraph1]="deleteMessage" [paragraph2]="'This action cannot be undone.'"
    [isOpen]="showDeleteConfirmModal" (close)="closeDeleteConfirmModal()">
    <button modal-btn-left class="btn btn-lg btn-danger w-100" (click)="confirmDeleteField()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
            <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z" />
        </svg>
        Delete Field
    </button>
    <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeDeleteConfirmModal()">
        Cancel
    </button>
</app-popup>