<!-- start page header -->
<app-page-header [breadcrumbs]="breadcrumbs" [title]="'View Assignment - ' + (assignment?.name || 'Assignment Details')"
  [create]="formattedCreatedAt" [update]="formattedUpdatedAt">
  @if (!isLoading && assignment) {
  <button class="btn btn-lg btn-primary" [routerLink]="['/assignments/edit', assignment?.id]">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <g fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round"
          d="M22 10.5V12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12s0-7.071 1.464-8.536C4.93 2 7.286 2 12 2h1.5" />
        <path
          d="m16.652 3.455l.649-.649A2.753 2.753 0 0 1 21.194 6.7l-.65.649m-3.892-3.893s.081 1.379 1.298 2.595c1.216 1.217 2.595 1.298 2.595 1.298m-3.893-3.893L10.687 9.42c-.404.404-.606.606-.78.829q-.308.395-.524.848c-.121.255-.211.526-.392 1.068L8.412 13.9m12.133-6.552l-5.965 5.965c-.404.404-.606.606-.829.78a4.6 4.6 0 0 1-.848.524c-.255.121-.526.211-1.068.392l-1.735.579m0 0l-1.123.374a.742.742 0 0 1-.939-.94l.374-1.122m1.688 1.688L8.412 13.9" />
      </g>
    </svg>
    <span>Edit</span>
  </button>
  } @if (!isLoading && assignment && !assignment?.is_active) {
  <button class="btn btn-lg btn-outline-success" (click)="openActivate()" [disabled]="isActivating || isDeactivating">
    @if (isActivating) {
    <span class="spinner-bubble"></span>
    <span>Activating...</span>
    } @else {
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Activate</span>
    }
  </button>
  } @if (!isLoading && assignment && assignment?.is_active) {
  <button class="btn btn-lg btn-outline-danger" (click)="openDeactivate()" [disabled]="isActivating || isDeactivating">
    @if (isDeactivating) {
    <span class="spinner-bubble"></span>
    <span>Deactivating...</span>
    } @else {
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Deactivate</span>
    }
  </button>
  }
</app-page-header>
<!-- end page header -->

<!-- start content -->
<div class="content-hug d-flex flex-column gap-4">
  <!-- Loading State -->
  @if (isLoading) {
  <!-- Summary Bar Skeleton -->
  <div class="content-box placeholder-glow">
    <div class="assignment-summary">
      <div class="summary-title">
        <div class="placeholder col-3" style="height: 14px; margin-bottom: 8px"></div>
        <div class="placeholder col-6" style="height: 28px; border-radius: 4px"></div>
      </div>
      <div class="summary-stats">
        <div class="stat-item">
          <div class="placeholder col-6" style="height: 14px; margin-bottom: 8px"></div>
          <div class="placeholder col-4" style="height: 20px; border-radius: 4px"></div>
        </div>
        <div class="stat-item">
          <div class="placeholder col-5" style="height: 14px; margin-bottom: 8px"></div>
          <div class="placeholder col-4" style="height: 20px; border-radius: 4px"></div>
        </div>
        <div class="stat-item">
          <div class="placeholder col-5" style="height: 14px; margin-bottom: 8px"></div>
          <div class="placeholder col-4" style="height: 20px; border-radius: 4px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Questions Skeleton -->
  <div class="questions-container placeholder-glow">
    @for (i of [1, 2, 3]; track i) {
    <div class="content-box question-item">
      <!-- Question Header Skeleton -->
      <div class="question-header mb-3">
        <div class="d-flex align-items-center gap-2" style="flex: 1">
          <div class="placeholder col-1" style="height: 28px; border-radius: 4px"></div>
          <div class="placeholder col-8" style="height: 20px; border-radius: 4px"></div>
        </div>
        <div class="question-meta d-flex gap-2">
          <div class="badge-item">
            <div class="placeholder col-4" style="height: 14px; margin-bottom: 4px"></div>
            <div class="placeholder col-5" style="height: 18px; border-radius: 4px"></div>
          </div>
          <div class="badge-item">
            <div class="placeholder col-3" style="height: 14px; margin-bottom: 4px"></div>
            <div class="placeholder col-4" style="height: 18px; border-radius: 4px"></div>
          </div>
        </div>
      </div>

      <!-- Media Section Skeleton -->
      <div class="question-media mb-3">
        <div class="media-item">
          <div class="placeholder col-12" style="height: 200px; border-radius: 8px"></div>
        </div>
      </div>

      <!-- Answer Options Skeleton (MCQ) -->
      <div class="question-answers">
        @for (j of [1, 2, 3, 4]; track j) {
        <div class="answer-wrapper mb-2">
          <div class="placeholder col-1" style="height: 32px; border-radius: 50%"></div>
          <div class="answer-item" style="flex: 1; margin-left: 12px">
            <div class="placeholder col-10" style="height: 18px; border-radius: 4px"></div>
          </div>
        </div>
        }
      </div>
    </div>
    }
  </div>
  }

  <!-- Content -->
  @if (!isLoading && assignment) {
  <!-- Summary Bar -->
  <div class="content-box">
    <div class="assignment-summary">
      <div class="summary-title">
        <h5>{{ assignment.code }}</h5>
        <h4>{{ assignment.name }}</h4>
      </div>
      <div class="summary-stats">
        <div class="stat-item">
          <span class="stat-label">Total Questions</span>
          <span class="stat-value">{{
            assignment.questions?.length || 0
            }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Full Score</span>
          <span class="stat-value">{{ getTotalScore() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Total Time</span>
          <span class="stat-value">{{ assignment.duration_minutes }} mins</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Questions Section -->
  @if (assignment?.questions && assignment.questions.length > 0) {
  <div class="questions-container">
    @for (question of assignment.questions; let i = $index; track i) {
    <div class="content-box question-item">
      <!-- Question Header -->
      <div class="question-header">
        <span class="question-number">{{ i + 1 }}</span>
        <span class="question-title">{{ question.question_text }}</span>
        <div class="question-meta">
          <div class="badge-item">
            <span class="badge-label">Type</span>
            <span class="badge-value">{{
              question.question_type?.name || "Question"
              }}</span>
          </div>
          <div class="badge-item">
            <span class="badge-label">Score</span>
            <span class="badge-value">{{ question.points }}</span>
          </div>
        </div>
      </div>

      <!-- Media Section -->
      @if (question.media && question.media.length > 0) {
      <div class="question-media">
        @for (media of question.media; track getAnswerId(media)) {
        <div class="media-item">
          @if (media.media_type?.name === 'Image') {
          <img [src]="
              media.document_url?.generate_signed_url ||
              media.document_url?.signed_url ||
              media.document_url?.url
            " [alt]="question.question_text" class="media-image" />
          } @else if (media.media_type?.name === 'Video') {
          <video controls class="media-video">
            <source [src]="
                media.document_url?.generate_signed_url ||
                media.document_url?.signed_url ||
                media.document_url?.url
              " type="video/mp4" />
            Your browser does not support the video tag.
          </video>
          }
        </div>
        }
      </div>
      }

      <!-- Answer Options (MCQ & True/False) -->
      @if ((question.question_type?.name === 'MCQ' || question.question_type?.name === 'True & False') &&
      question.answers &&
      question.answers.length > 0) {
      <div class="question-answers">
        @for (answer of question.answers | slice: 0:4; let ansIndex = $index;
        track getAnswerId(answer)) {
        <div class="answer-wrapper" [ngClass]="{ correct: isCorrectAnswer(answer) }">
          <span class="answer-letter">{{ getAnswerLetter(ansIndex) }}</span>
          <div class="answer-item">
            <span class="answer-text">{{ getAnswerText(answer) }}</span>
            @if (isCorrectAnswer(answer)) {
            <svg xmlns="http://www.w3.org/2000/svg" width="17" height="17" viewBox="0 0 17 17" fill="none">
              <path
                d="M11.0852 6.58525C11.3049 6.36558 11.3049 6.00942 11.0852 5.78975C10.8656 5.57008 10.5094 5.57008 10.2898 5.78975L6.9375 9.142L5.83525 8.03975C5.61558 7.82008 5.25942 7.82008 5.03975 8.03975C4.82008 8.25942 4.82008 8.61558 5.03975 8.83525L6.53975 10.3352C6.75942 10.5549 7.11558 10.5549 7.33525 10.3352L11.0852 6.58525Z"
                fill="#377AFD" />
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M8.0625 0C3.6097 0 0 3.6097 0 8.0625C0 12.5153 3.6097 16.125 8.0625 16.125C12.5153 16.125 16.125 12.5153 16.125 8.0625C16.125 3.6097 12.5153 0 8.0625 0ZM1.125 8.0625C1.125 4.23102 4.23102 1.125 8.0625 1.125C11.894 1.125 15 4.23102 15 8.0625C15 11.894 11.894 15 8.0625 15C4.23102 15 1.125 11.894 1.125 8.0625Z"
                fill="#377AFD" />
            </svg>
            }
          </div>
        </div>
        }
      </div>
      }
    </div>
    }
  </div>
  } }

  <!-- Empty State -->
  @if (!isLoading && !assignment) {
  <div class="content-box text-center p-5">
    <p class="text-muted">Assignment not found.</p>
  </div>
  }
</div>
<!-- end content -->

<!-- deactivate popup -->
<app-popup [title]="'Deactivate Assignment'" [paragraph1]="
    'Are you sure you want to deactivate the assignment ' +
    (assignment?.name || '') +
    '?'
  " [paragraph2]="'You can activate it later.'" [isOpen]="deactivateOpen" (close)="closeDeactivate()">
  <button modal-btn-left class="btn btn-lg btn-danger w-100" (click)="confirmDeactivate()"
    [disabled]="isDeactivating || isActivating">
    @if (isDeactivating) {
    <span class="spinner-bubble"></span>
    <span>Deactivating...</span>
    } @else {
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Deactivate</span>
    }
  </button>
  <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeDeactivate()"
    [disabled]="isDeactivating || isActivating">
    Cancel
  </button>
</app-popup>

<!-- activate popup -->
<app-popup [title]="'Activate Assignment'" [paragraph1]="
    'Are you sure you want to activate the assignment ' +
    (assignment?.name || '') +
    '?'
  " [paragraph2]="'You can deactivate it at any time later.'" [isOpen]="activateOpen" (close)="closeActivate()">
  <button modal-btn-left class="btn btn-lg btn-success w-100" (click)="confirmActivate()"
    [disabled]="isActivating || isDeactivating">
    @if (isActivating) {
    <span class="spinner-bubble"></span>
    <span>Activating...</span>
    } @else {
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24">
      <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-width="1.5"
        d="M12 2v4M8.5 3.706A9.003 9.003 0 0 0 12 21a9 9 0 0 0 3.5-17.294" />
    </svg>
    <span>Activate</span>
    }
  </button>
  <button modal-btn-right class="btn btn-lg btn-outline-dark border-0 w-100" (click)="closeActivate()"
    [disabled]="isActivating || isDeactivating">
    Cancel
  </button>
</app-popup>