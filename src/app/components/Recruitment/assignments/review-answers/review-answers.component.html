<!-- start page header -->
<app-page-header [breadcrumbs]="breadcrumbs" [title]="'Review Answers'">
</app-page-header>
<!-- end page header -->

<!-- start content -->
<div class="content-hug d-flex flex-column gap-4">
  <!-- Loading State -->
  @if (isLoading) {
  <!-- Summary Bar Skeleton -->
  <div class="content-box placeholder-glow">
    <div class="assignment-summary d-flex gap-2">
      <div class="stat-item stat-item-no-border">
        <div class="placeholder col-6" style="height: 14px; margin-bottom: 8px;"></div>
        <div class="placeholder col-4" style="height: 20px; border-radius: 4px;"></div>
      </div>
      <div class="stat-item">
        <div class="placeholder col-6" style="height: 14px; margin-bottom: 8px;"></div>
        <div class="placeholder col-4" style="height: 20px; border-radius: 4px;"></div>
      </div>
      <div class="stat-item">
        <div class="placeholder col-5" style="height: 14px; margin-bottom: 8px;"></div>
        <div class="placeholder col-4" style="height: 20px; border-radius: 4px;"></div>
      </div>
      <div class="stat-item">
        <div class="placeholder col-5" style="height: 14px; margin-bottom: 8px;"></div>
        <div class="placeholder col-4" style="height: 20px; border-radius: 4px;"></div>
      </div>
    </div>
  </div>

  <!-- Questions Skeleton -->
  <div class="questions-container placeholder-glow">
    @for (i of [1, 2, 3]; track i) {
    <div class="content-box question-item">
      <div class="question-header mb-3">
        <div class="d-flex align-items-center gap-2" style="flex: 1">
          <div class="placeholder col-1" style="height: 28px; border-radius: 4px;"></div>
          <div class="placeholder col-8" style="height: 20px; border-radius: 4px;"></div>
        </div>
        <div class="question-meta d-flex gap-2">
          <div class="badge-item">
            <div class="placeholder col-4" style="height: 14px; margin-bottom: 4px;"></div>
            <div class="placeholder col-5" style="height: 18px; border-radius: 4px;"></div>
          </div>
        </div>
      </div>
      <div class="placeholder col-12" style="height: 100px; border-radius: 8px;"></div>
    </div>
    }
  </div>
  }

  <!-- Content -->
  @if (!isLoading && applicantAssignment && assignment) {
  <!-- Summary Bar -->
  <div class="content-box">
    <div class="assignment-summary d-flex gap-2">
      <div class="stat-item stat-item-no-border">
        <span class="stat-label">{{ assignment?.id || 'N/A' }}</span>
        <span class="stat-value">{{ assignment?.name || 'Assignment Name' }}</span>
      </div>
      @if (getRecruiterSideStatus() === 'Pending Review') {
      <div class="stat-item">
        <span class="stat-label">Pending Review</span>
        <span class="stat-value">{{ getPendingReviewCount() }}</span>
      </div>
      } @else {
      <div class="stat-item">
        <span class="stat-label">Status</span>
        <span class="stat-value">{{ getRecruiterSideStatus() || 'N/A' }}</span>
      </div>
      }
      <div class="stat-item">
        <span class="stat-label">Current Score</span>
        <span class="stat-value">{{ getCurrentScore() }}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Total Score</span>
        <span class="stat-value">{{ getTotalScore() }}</span>
      </div>
    </div>
  </div>

  <!-- Questions Section -->
  @if (applicantAnswers && applicantAnswers.length > 0) {
  <div class="questions-container">
    @for (answer of applicantAnswers; track answer.question?.id; let i = $index) {
    @if (answer.question) {
    <div class="content-box question-item">
      <!-- Question Header -->
      <div class="question-header">
        <span class="question-number">{{ i + 1 }}</span>
        <span class="question-title">{{ answer.question.text || 'Question Title' }}</span>
        <div class="question-meta">
          <div class="badge-item">
            <span class="badge-label">Type</span>
            <span class="badge-value">{{ answer.question.type || 'Question' }}</span>
          </div>
          <div class="badge-item">
            <span class="badge-label">Score</span>
            <span class="badge-value">{{ answer.question.points || 0 }}</span>
          </div>
        </div>
      </div>

      <!-- MCQ Questions: Show all answers with highlighting -->
      @if (answer.question.type === 'MCQ' && answer.answers && answer.answers.length > 0) {
      <div class="answers-section">
        <h6 class="answers-title">Answers</h6>
        @for (ans of answer.answers; let ansIndex = $index; track ansIndex) {
        <div style="width: 50%; margin-bottom: 12px;">
          <div class="answer-row">
            <span class="answer-label">{{ getAnswerLetter(ansIndex) }}</span>
            <div style="flex: 1">
              <div class="form-outline w-100 position-relative custom-date-wrapper">
                <input type="text" class="form-control custom-date-input" [value]="ans.text || 'No answer text'"
                  disabled
                  [style.border-color]="isCorrectAnswer(ans) ? '#10B981' : (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans) ? '#EF4444' : '#93A7C1')"
                  [style.background-color]="isCorrectAnswer(ans) ? '#D4F4DD' : (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans) ? '#FEE2E2' : '#F3F4F6')"
                  [style.color]="isCorrectAnswer(ans) ? '#10B981' : (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans) ? '#EF4444' : '#1F2937')"
                  [style.padding-right]="(isCorrectAnswer(ans) || (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans))) ? '40px' : '16px'" />
                @if (isCorrectAnswer(ans)) {
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                  style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                  <g clip-path="url(#clip0_1854_29644)">
                    <g clip-path="url(#clip1_1854_29644)">
                      <path
                        d="M12.0227 7.52275C12.2424 7.30308 12.2424 6.94692 12.0227 6.72725C11.8031 6.50758 11.4469 6.50758 11.2273 6.72725L7.875 10.0795L6.77275 8.97725C6.55308 8.75758 6.19692 8.75758 5.97725 8.97725C5.75758 9.19692 5.75758 9.55308 5.97725 9.77275L7.47725 11.2727C7.69692 11.4924 8.05308 11.4924 8.27275 11.2727L12.0227 7.52275Z"
                        fill="#4CA883" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M9 0.9375C4.5472 0.9375 0.9375 4.5472 0.9375 9C0.9375 13.4528 4.5472 17.0625 9 17.0625C13.4528 17.0625 17.0625 13.4528 17.0625 9C17.0625 4.5472 13.4528 0.9375 9 0.9375ZM2.0625 9C2.0625 5.16852 5.16852 2.0625 9 2.0625C12.8315 2.0625 15.9375 5.16852 15.9375 9C15.9375 12.8315 12.8315 15.9375 9 15.9375C5.16852 15.9375 2.0625 12.8315 2.0625 9Z"
                        fill="#4CA883" />
                    </g>
                  </g>
                  <defs>
                    <clipPath id="clip0_1854_29644">
                      <rect width="18" height="18" fill="white" />
                    </clipPath>
                    <clipPath id="clip1_1854_29644">
                      <rect width="18" height="18" fill="white" />
                    </clipPath>
                  </defs>
                </svg>
                } @else if (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans)) {
                <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg"
                  style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                  <path
                    d="M6.58522 5.78974C6.36555 5.57007 6.0094 5.57007 5.78973 5.78974C5.57006 6.00941 5.57006 6.36557 5.78973 6.58524L7.26699 8.0625L5.78975 9.53974C5.57008 9.75941 5.57008 10.1156 5.78975 10.3352C6.00942 10.5549 6.36557 10.5549 6.58524 10.3352L8.06248 8.85799L9.53971 10.3352C9.75938 10.5549 10.1155 10.5549 10.3352 10.3352C10.5549 10.1156 10.5549 9.7594 10.3352 9.53973L8.85798 8.0625L10.3352 6.58525C10.5549 6.36558 10.5549 6.00943 10.3352 5.78976C10.1156 5.57009 9.7594 5.57009 9.53973 5.78976L8.06248 7.267L6.58522 5.78974Z"
                    fill="#E04F5F" />
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M8.0625 0C3.6097 0 0 3.6097 0 8.0625C0 12.5153 3.6097 16.125 8.0625 16.125C12.5153 16.125 16.125 12.5153 16.125 8.0625C16.125 3.6097 12.5153 0 8.0625 0ZM1.125 8.0625C1.125 4.23102 4.23102 1.125 8.0625 1.125C11.894 1.125 15 4.23102 15 8.0625C15 11.894 11.894 15 8.0625 15C4.23102 15 1.125 11.894 1.125 8.0625Z"
                    fill="#E04F5F" />
                </svg>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>
      }

      <!-- True & False Questions: Show all answers with highlighting -->
      @else if (answer.question.type === 'True & False' && answer.answers && answer.answers.length > 0) {
      <div class="answers-section">
        <h6 class="answers-title">Answers</h6>
        @for (ans of answer.answers; let ansIndex = $index; track ansIndex) {
        <div style="width: 50%; margin-bottom: 12px;">
          <div class="answer-row">
            <div style="flex: 1">
              <div class="form-outline w-100 position-relative custom-date-wrapper">
                <input type="text" class="form-control custom-date-input" [value]="ans.text || 'No answer text'"
                  disabled
                  [style.border-color]="isCorrectAnswer(ans) ? '#10B981' : (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans) ? '#EF4444' : '#93A7C1')"
                  [style.background-color]="isCorrectAnswer(ans) ? '#D4F4DD' : (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans) ? '#FEE2E2' : '#F3F4F6')"
                  [style.color]="isCorrectAnswer(ans) ? '#10B981' : (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans) ? '#EF4444' : '#1F2937')"
                  [style.padding-right]="(isCorrectAnswer(ans) || (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans))) ? '40px' : '16px'" />
                @if (isCorrectAnswer(ans)) {
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
                  style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                  <g clip-path="url(#clip0_1854_29644_tf)">
                    <g clip-path="url(#clip1_1854_29644_tf)">
                      <path
                        d="M12.0227 7.52275C12.2424 7.30308 12.2424 6.94692 12.0227 6.72725C11.8031 6.50758 11.4469 6.50758 11.2273 6.72725L7.875 10.0795L6.77275 8.97725C6.55308 8.75758 6.19692 8.75758 5.97725 8.97725C5.75758 9.19692 5.75758 9.55308 5.97725 9.77275L7.47725 11.2727C7.69692 11.4924 8.05308 11.4924 8.27275 11.2727L12.0227 7.52275Z"
                        fill="#4CA883" />
                      <path fill-rule="evenodd" clip-rule="evenodd"
                        d="M9 0.9375C4.5472 0.9375 0.9375 4.5472 0.9375 9C0.9375 13.4528 4.5472 17.0625 9 17.0625C13.4528 17.0625 17.0625 13.4528 17.0625 9C17.0625 4.5472 13.4528 0.9375 9 0.9375ZM2.0625 9C2.0625 5.16852 5.16852 2.0625 9 2.0625C12.8315 2.0625 15.9375 5.16852 15.9375 9C15.9375 12.8315 12.8315 15.9375 9 15.9375C5.16852 15.9375 2.0625 12.8315 2.0625 9Z"
                        fill="#4CA883" />
                    </g>
                  </g>
                  <defs>
                    <clipPath id="clip0_1854_29644_tf">
                      <rect width="18" height="18" fill="white" />
                    </clipPath>
                    <clipPath id="clip1_1854_29644_tf">
                      <rect width="18" height="18" fill="white" />
                    </clipPath>
                  </defs>
                </svg>
                } @else if (isSelectedAnswer(ans.id, answer) && !isCorrectAnswer(ans)) {
                <svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg"
                  style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                  <path
                    d="M6.58522 5.78974C6.36555 5.57007 6.0094 5.57007 5.78973 5.78974C5.57006 6.00941 5.57006 6.36557 5.78973 6.58524L7.26699 8.0625L5.78975 9.53974C5.57008 9.75941 5.57008 10.1156 5.78975 10.3352C6.00942 10.5549 6.36557 10.5549 6.58524 10.3352L8.06248 8.85799L9.53971 10.3352C9.75938 10.5549 10.1155 10.5549 10.3352 10.3352C10.5549 10.1156 10.5549 9.7594 10.3352 9.53973L8.85798 8.0625L10.3352 6.58525C10.5549 6.36558 10.5549 6.00943 10.3352 5.78976C10.1156 5.57009 9.7594 5.57009 9.53973 5.78976L8.06248 7.267L6.58522 5.78974Z"
                    fill="#E04F5F" />
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M8.0625 0C3.6097 0 0 3.6097 0 8.0625C0 12.5153 3.6097 16.125 8.0625 16.125C12.5153 16.125 16.125 12.5153 16.125 8.0625C16.125 3.6097 12.5153 0 8.0625 0ZM1.125 8.0625C1.125 4.23102 4.23102 1.125 8.0625 1.125C11.894 1.125 15 4.23102 15 8.0625C15 11.894 11.894 15 8.0625 15C4.23102 15 1.125 11.894 1.125 8.0625Z"
                    fill="#E04F5F" />
                </svg>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>
      }

      <!-- Text/Image Answer (Essay Questions) -->
      @else {
      <!-- Text/Image Answer -->
      @if (answer.answer_image_url || answer.media_url) {
      <div class="question-media">
        <div class="media-item">
          <img [src]="answer.answer_image_url || answer.media_url" [alt]="answer.question.text" class="media-image" />
        </div>
      </div>
      }
      @if (answer.text_answer) {
      <div class="text-answer">
        <div class="answer-text-content">{{ answer.text_answer }}</div>
      </div>
      }
      @if (!answer.text_answer && !answer.answer_image_url && !answer.media_url && !answer.selected_answer) {
      <div class="text-answer">
        <div class="answer-text-content text-muted">No answer provided</div>
      </div>
      }

      <!-- Points Input and Submit Button (only for Text/Essay questions) -->
      <div class="review-section">
        <h6 class="answers-title">Review</h6>
        <div class="essay-review-row">
          <div class="points-input-wrapper">
            <label for="points-{{ answer.question.id }}" class="points-label">Points</label>
            <div class="form-outline position-relative custom-date-wrapper">
              <input
                type="number"
                id="points-{{ answer.question.id }}"
                class="form-control custom-date-input points-input"
                [class.is-invalid]="getEssayValidationError(answer.question.id)"
                [ngModel]="getEssayPoints(answer.question.id)"
                (ngModelChange)="setEssayPoints(answer.question.id, $event, answer.question?.points)"
                (blur)="validateEssayPoints(answer.question.id, answer.question?.points)"
                [min]="0"
                [max]="answer.question?.points || 0"
                step="0.1"
                placeholder="Enter points"
              />
              <span class="points-max">/ {{ answer.question?.points || 0 }}</span>
            </div>
            @if (getEssayValidationError(answer.question.id)) {
            <small class="text-danger d-block mt-1">{{ getEssayValidationError(answer.question.id) }}</small>
            }
          </div>
          <button
            type="button"
            class="btn btn-lg btn-primary submit-points-btn"
            (click)="submitEssayReview(answer)"
            [disabled]="isEssayLoading(answer.question.id) || !canSubmitEssayPoints(answer.question.id) || !!getEssayValidationError(answer.question.id)"
          >
            @if (isEssayLoading(answer.question.id)) {
            <div class="d-flex align-items-center gap-2">
              <div class="loading-bubble"></div>
              <div class="loading-bubble"></div>
              <div class="loading-bubble"></div>
            </div>
            <span>Submitting...</span>
            } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 6L9 17l-5-5"></path>
            </svg>
            <span>Submit Points</span>
            }
          </button>
        </div>
      </div>
      }
    </div>
    }
    }
  </div>
  }

  <!-- Submit Review Button -->
  <div class="d-flex justify-content-end">
    <button type="button" class="btn btn-lg btn-primary" (click)="submitReview()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20 6L9 17l-5-5"></path>
      </svg>
      <span>Submit Review</span>
    </button>
  </div>
  }
</div>
<!-- end content -->